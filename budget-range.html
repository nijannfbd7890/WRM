<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Budget Range Report | WRM Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

<style>
body {
  background: linear-gradient(135deg, #015871, #01414d);
  font-family: "Segoe UI", sans-serif;
  color: white;
  text-align: center;
  margin: 0;
  padding: 0;
}
header {
  background: linear-gradient(90deg, #003d52, #026b8a);
  box-shadow: 0 2px 8px rgba(0,0,0,0.4);
  padding: 12px;
}
header img {
  position: absolute;
  left: 25px;
  background-color: white;
  border-radius: 10px;
  padding: 6px;
  height: 80px;
  width: auto;
}
h1 {
  font-size: 1.6rem;
  line-height: 1.4;
  margin: 0;
}
nav {
  display: flex;
  justify-content: center;
  gap: 15px;
  background: rgba(255,255,255,0.1);
  padding: 10px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.3);
}
nav a {
  color: white;
  text-decoration: none;
  font-weight: bold;
  background: #026b8a;
  padding: 8px 15px;
  border-radius: 6px;
  transition: 0.3s;
}
nav a:hover {
  background: #ffb347;
  color: #003d52;
}
nav a.active {
  background: #ffb347;
  color: #003d52;
}
.filters { margin: 15px; }
select {
  padding: 8px; margin: 0 8px;
  border-radius: 5px; font-size: 1rem;
}
table {
  width: 95%; margin: 15px auto;
  border-collapse: collapse;
  font-size: 0.9rem; text-align: center;
}
th, td {
  padding: 8px;
  border: 1px solid rgba(255,255,255,0.2);
}
th { background-color: rgba(255,255,255,0.2); }
tfoot tr {
  background-color: rgba(255,255,255,0.3);
  font-weight: bold;
}
/* DASHBOARD CARDS */
.cards {
  display: flex;
  justify-content: center;
  flex-wrap: wrap;
  gap: 20px;
  margin: 25px;
}
.card {
  background: rgba(255, 255, 255, 0.15);
  border-radius: 14px;
  padding: 20px;
  min-width: 200px;
  width: 220px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.3);
  transition: transform 0.3s;
}
.card:hover {
  transform: scale(1.05);
}
.card h2 {
  margin: 0;
  font-size: 2rem;
  color: #ffde59;
}
.card p {
  margin: 5px 0 0;
  font-size: 1rem;
}
#chartContainer {
  width: 90%; max-width: 1000px;
  margin: 25px auto; height: 400px;
  background: rgba(255,255,255,0.05);
  border-radius: 10px; padding: 15px;
  box-shadow: 0 0 8px rgba(255,255,255,0.2);
}
canvas { width: 100% !important; height: 100% !important; }
</style>
</head>
<body>
<header>
  <img src="LOGO.png" alt="Company Logo" />
  <h1>
    Namma Family Builder and Developer Pvt. Ltd<br>
    WRM Report Analysis Dashboard<br>
    Budget Range Report
  </h1>
</header>
<nav>
  <a href="index.html">üè† Dashboard</a>
  <a href="advance-range.html" >üìä Advance Range</a>
  <a href="budget-range.html" class="active">üí∞ Budget Range</a>
  <a href="sqft-range.html">üìê Sqft Range</a>
  <a href="negotiable-range.html">ü§ù Negotiable Range</a>
  <a href="location-report.html">üìç Location</a>
</nav>

<div class="filters">
  <select id="yearFilter"><option value="All">All Years</option></select>
  <select id="monthFilter"><option value="All">All Months</option></select>
  <!-- <button class="back" onclick="window.location.href='index.html'">‚¨Ö Back to Dashboard</button> -->
</div>

<!-- DASHBOARD CARDS -->
<div class="cards">
  <div class="card"><h2 id="totalBookings">0</h2><p>Total Bookings</p></div>
  <div class="card"><h2 id="totalSqft">0</h2><p>Total Sq Ft</p></div>
  <div class="card"><h2 id="selectedYear">All</h2><p>Selected Year</p></div>
  <div class="card"><h2 id="selectedMonth">All</h2><p>Selected Month</p></div>
</div>


<h2>BUDGET RANGE</h2>

<table id="budgetTable">
  <thead>
    <tr>
      <th rowspan="2">Team Name</th>
      <th colspan="2">Overall</th>
      <th colspan="3">Below 20L</th>
      <th colspan="3">20‚Äì30L</th>
      <th colspan="3">30‚Äì40L</th>
      <th colspan="3">40‚Äì70L</th>
      <th colspan="3">Above 70L</th>
    </tr>
    <tr>
      <th>Count</th><th>Sq Ft</th>
      <th>Count</th><th>Sq Ft</th><th>%</th>
      <th>Count</th><th>Sq Ft</th><th>%</th>
      <th>Count</th><th>Sq Ft</th><th>%</th>
      <th>Count</th><th>Sq Ft</th><th>%</th>
      <th>Count</th><th>Sq Ft</th><th>%</th>
    </tr>
  </thead>
  <tbody></tbody>
  <tfoot></tfoot>
</table>

<div id="chartContainer">
  <canvas id="budgetChart"></canvas>
</div>

<script>
let allData = [], monthsByYear = {}, chartInstance = null;

// ‚úÖ Canonical team name mapping
const TEAM_CANONICAL = {
  "suriya sir & selvakumar sir": "Suriya Sir & Selvakumar Sir",
  "suriya sir": "Suriya Sir & Selvakumar Sir",
  "selvakumar sir": "Suriya Sir & Selvakumar Sir",
  "latha mam & ayyappan sir": "Latha Mam & Ayyappan Sir",
  "latha mam": "Latha Mam & Ayyappan Sir",
  "ayyappan sir": "Latha Mam & Ayyappan Sir"
};

// Title Case Helper
function titleCase(str) {
  if (!str) return "";
  return str
    .toLowerCase()
    .replace(/\s*&\s*/g, " & ")
    .split(" ")
    .filter(w => w.trim() !== "")
    .map(w => w.charAt(0).toUpperCase() + w.slice(1))
    .join(" ")
    .trim();
}

// Normalize Team Names
function normalizeTeamName(value) {
  let raw = (value || "Unknown").trim();
  let key = raw.toLowerCase().replace(/\s*&\s*/g, " & ").replace(/\s+/g, " ").trim();
  return TEAM_CANONICAL[key] || titleCase(key);
}

Papa.parse("https://nijannfbd7890.github.io/WRM/workbook.csv", {
  download: true, header: true,
  complete: res => initBudgetDashboard(res.data)
});

function initBudgetDashboard(data) {
  const norm = s => s ? s.trim().toLowerCase() : "";
  const f = data[0];
  const teamKey = Object.keys(f).find(k => norm(k) === "team name");
  const sqftKey = Object.keys(f).find(k => norm(k).includes("actual total sq-ft"));
  const dateKey = Object.keys(f).find(k => norm(k).includes("booking"));
  const rangeKey = Object.keys(f).find(k => norm(k) === "budget range");

  if (!teamKey || !sqftKey || !dateKey || !rangeKey) {
    alert("‚ö† Missing required columns in CSV!");
    return;
  }

  allData = data.filter(d => d[teamKey]);
  populateFilters(allData, dateKey);
  updateBudgetRange("All", "All", teamKey, sqftKey, dateKey, rangeKey);

  document.getElementById("yearFilter").addEventListener("change", e => {
    updateMonthDropdown(e.target.value);
    updateBudgetRange(e.target.value, monthFilter.value, teamKey, sqftKey, dateKey, rangeKey);
  });
  document.getElementById("monthFilter").addEventListener("change", e => {
    updateBudgetRange(yearFilter.value, e.target.value, teamKey, sqftKey, dateKey, rangeKey);
  });
}

function populateFilters(data,dateKey){
  const years=[]; monthsByYear={};
  data.forEach(r=>{
    const raw=(r[dateKey]||"").trim();
    if(!raw)return;
    const [d,m,y]=raw.split(/[-\/]/);
    if(!y)return;
    const year=parseInt(y);
    const mon=new Date(`${y}-${m}-01`).toLocaleString('en',{month:'short'})+"-"+y.slice(-2);
    if(!years.includes(year))years.push(year);
    if(!monthsByYear[year])monthsByYear[year]=[];
    if(!monthsByYear[year].includes(mon))monthsByYear[year].push(mon);
  });
  years.sort((a,b)=>b-a);
  const yearSel=document.getElementById("yearFilter");
  yearSel.innerHTML='<option value="All">All Years</option>';
  years.forEach(y=>yearSel.innerHTML+=`<option>${y}</option>`);
  updateMonthDropdown("All");
}

function updateMonthDropdown(selectedYear){
  const monthSel=document.getElementById("monthFilter");
  monthSel.innerHTML='<option value="All">All Months</option>';
  if(selectedYear!=="All"){
    (monthsByYear[selectedYear]||[]).forEach(m=>monthSel.innerHTML+=`<option>${m}</option>`);
  } else {
    const allMonths=[...new Set(Object.values(monthsByYear).flat())];
    allMonths.forEach(m=>monthSel.innerHTML+=`<option>${m}</option>`);
  }
}


function updateBudgetRange(year, month, teamKey, sqftKey, dateKey, rangeKey) {
  const filtered = allData.filter(r => {
    const raw = (r[dateKey] || "").trim();
    if (!raw) return false;
    const [d, m, y] = raw.split(/[-\/]/);
    if (!y) return false;
    const rowYear = parseInt(y);
    const rowMonth = new Date(`${y}-${m}-01`).toLocaleString('en', { month: 'short' }) + "-" + y.slice(-2);
    if (year !== "All" && rowYear != year) return false;
    if (month !== "All" && rowMonth.toLowerCase() != month.toLowerCase()) return false;
    return true;
  });

  const teams = {};
  filtered.forEach(r => {
    <!-- const team = (r[teamKey] || "Unknown").trim(); -->
    <!-- const range = (r[rangeKey] || "").toLowerCase(); -->
    <!-- const sqft = parseFloat((r[sqftKey] || "0").replace(/,/g, "")) || 0; -->
	const team = normalizeTeamName(r[teamKey]); // ‚úÖ fixed here
    const range = (r[rangeKey] || "").toLowerCase();
    <!-- const sqft = parseFloat((r[sqftKey] || "0").replace(/,/g, "").replace(/[^0-9.]/g, "")) || 0; -->
	let sqft = 0;
    const sqftCols = Object.keys(r).filter(k =>
      k.toLowerCase().startsWith("actual total sq-ft") && !k.toLowerCase().includes("budget range")
    );
    sqftCols.forEach(col => {
      const raw = (r[col] + "").replace(/,/g, "").trim();
      const val = parseFloat(raw) || 0;
      sqft += val;
    });

    if (!teams[team]) {
      teams[team] = {
        totalCount: 0, totalSqft: 0,
        below20: { count: 0, sqft: 0 },
        range20to30: { count: 0, sqft: 0 },
        range30to40: { count: 0, sqft: 0 },
        range40to70: { count: 0, sqft: 0 },
        above70: { count: 0, sqft: 0 }
      };
    }

    const t = teams[team];
    t.totalCount++;
    t.totalSqft += sqft;

    if (range.includes("below 20")) t.below20.count++, t.below20.sqft += sqft;
    else if (range.includes("20") && range.includes("30")) t.range20to30.count++, t.range20to30.sqft += sqft;
    else if (range.includes("30") && range.includes("40")) t.range30to40.count++, t.range30to40.sqft += sqft;
    else if (range.includes("40") && range.includes("70")) t.range40to70.count++, t.range40to70.sqft += sqft;
    else if (range.includes("above 70")) t.above70.count++, t.above70.sqft += sqft;
  });

  const tbody=document.querySelector("#budgetTable tbody");
  const tfoot=document.querySelector("#budgetTable tfoot");
  tbody.innerHTML=""; tfoot.innerHTML="";

  let g={totalCount:0,totalSqft:0,below20:{count:0,sqft:0},range20to30:{count:0,sqft:0},range30to40:{count:0,sqft:0},range40to70:{count:0,sqft:0},above70:{count:0,sqft:0}};
  const pct=(p,t)=>t?Math.round((p/t)*100)+"%":"0%";

  const sorted = Object.entries(teams).sort((a,b)=>b[1].totalCount-a[1].totalCount);

  sorted.forEach(([team,t])=>{
    g.totalCount+=t.totalCount; g.totalSqft+=t.totalSqft;
    g.below20.count+=t.below20.count; g.below20.sqft+=t.below20.sqft;
    g.range20to30.count+=t.range20to30.count; g.range20to30.sqft+=t.range20to30.sqft;
    g.range30to40.count+=t.range30to40.count; g.range30to40.sqft+=t.range30to40.sqft;
    g.range40to70.count+=t.range40to70.count; g.range40to70.sqft+=t.range40to70.sqft;
    g.above70.count+=t.above70.count; g.above70.sqft+=t.above70.sqft;

    tbody.insertAdjacentHTML("beforeend",`
      <tr>
        <td>${team}</td><td>${t.totalCount}</td><td>${Math.round(t.totalSqft)}</td>
        <td>${t.below20.count}</td><td>${Math.round(t.below20.sqft)}</td><td>${pct(t.below20.count,t.totalCount)}</td>
        <td>${t.range20to30.count}</td><td>${Math.round(t.range20to30.sqft)}</td><td>${pct(t.range20to30.count,t.totalCount)}</td>
        <td>${t.range30to40.count}</td><td>${Math.round(t.range30to40.sqft)}</td><td>${pct(t.range30to40.count,t.totalCount)}</td>
        <td>${t.range40to70.count}</td><td>${Math.round(t.range40to70.sqft)}</td><td>${pct(t.range40to70.count,t.totalCount)}</td>
        <td>${t.above70.count}</td><td>${Math.round(t.above70.sqft)}</td><td>${pct(t.above70.count,t.totalCount)}</td>
      </tr>`);
  });

  tfoot.innerHTML=`
    <tr>
      <td>Grand Total</td><td>${g.totalCount}</td><td>${Math.round(g.totalSqft)}</td>
      <td>${g.below20.count}</td><td>${Math.round(g.below20.sqft)}</td><td>${pct(g.below20.count,g.totalCount)}</td>
      <td>${g.range20to30.count}</td><td>${Math.round(g.range20to30.sqft)}</td><td>${pct(g.range20to30.count,g.totalCount)}</td>
      <td>${g.range30to40.count}</td><td>${Math.round(g.range30to40.sqft)}</td><td>${pct(g.range30to40.count,g.totalCount)}</td>
      <td>${g.range40to70.count}</td><td>${Math.round(g.range40to70.sqft)}</td><td>${pct(g.range40to70.count,g.totalCount)}</td>
      <td>${g.above70.count}</td><td>${Math.round(g.above70.sqft)}</td><td>${pct(g.above70.count,g.totalCount)}</td>
    </tr>`;

  renderBudgetChart(sorted);
}

function renderBudgetChart(dataArr){
  const ctx=document.getElementById("budgetChart").getContext("2d");
  if(chartInstance)chartInstance.destroy();
  if(!dataArr.length) return;
  const labels=dataArr.map(([t])=>t);
  const counts=dataArr.map(([_,v])=>v.totalCount);

  chartInstance=new Chart(ctx,{
    type:"bar",
    plugins:[ChartDataLabels],
    data:{
      labels,
      datasets:[{
        label:"Bookings",
        data:counts,
        backgroundColor:(ctx)=>{
          const c=ctx.chart.ctx,area=ctx.chart.chartArea;
          if(!area)return "#00cc99";
          const g=c.createLinearGradient(0,area.bottom,0,area.top);
          g.addColorStop(0,"#ff9933");
          g.addColorStop(1,"#009933");
          return g;
        },
        borderColor:"rgba(255,255,255,0.8)",borderWidth:1
      }]
    },
    options:{
      responsive:true,maintainAspectRatio:false,
      plugins:{
        legend:{display:false},
        datalabels:{
          color:'white',anchor:'end',align:'start',font:{weight:'bold'},formatter:v=>v
        },
        title:{display:true,text:"Total Bookings per Team (Budget Range)",color:"white"}
      },
      scales:{
        x:{ticks:{color:"white",autoSkip:false,maxRotation:45,minRotation:45}},
        y:{ticks:{color:"white"},beginAtZero:true}
      }
    }
  });
}
</script>
</body>
</html>
