<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Advance Range Report</title>

<!-- ‚úÖ Libraries -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

<style>
body {
  font-family: "Segoe UI", sans-serif;
  background: linear-gradient(135deg, #01414d, #015871);
  color: white;
  margin: 0;
  text-align: center;
}
nav {
  display: flex;
  justify-content: center;
  gap: 15px;
  background: rgba(255,255,255,0.1);
  padding: 10px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.3);
}
nav a {
  text-decoration: none;
  color: white;
  background: #026b8a;
  padding: 10px 20px;
  border-radius: 6px;
  font-weight: bold;
}
nav a:hover {
  background: #ffb347;
  color: #003d52;
}
h2 {
  text-align: center;
  color: #fff;
  margin-top: 25px;
}
.filters {
  margin: 20px;
}
select {
  padding: 8px 12px;
  border-radius: 5px;
  font-size: 1rem;
}
.cards {
  display: flex;
  justify-content: center;
  flex-wrap: wrap;
  gap: 20px;
  margin: 20px;
}
.card {
  background: rgba(255,255,255,0.15);
  border-radius: 12px;
  padding: 20px;
  width: 220px;
  box-shadow: 0 4px 8px rgba(0,0,0,0.4);
}
.card h2 {
  margin: 0;
  color: #ffdb4d;
  font-size: 2rem;
}
table {
  width: 95%;
  margin: 25px auto;
  border-collapse: collapse;
  font-size: 0.9rem;
  text-align: center;
}
th, td {
  border: 1px solid rgba(255,255,255,0.2);
  padding: 8px;
}
th {
  background: rgba(255,255,255,0.15);
}
tfoot tr {
  background: rgba(255,255,255,0.25);
  font-weight: bold;
}
#chartContainer {
  width: 90%;
  max-width: 1100px;
  height: 450px;
  background: rgba(255,255,255,0.05);
  border-radius: 12px;
  padding: 15px;
  margin: 30px auto;
  box-shadow: 0 0 8px rgba(255,255,255,0.2);
}
canvas {
  width: 100% !important;
  height: 100% !important;
}
</style>
</head>
<body>

<!-- ‚úÖ Navigation -->
<nav>
  <a href="index.html">üè† Dashboard</a>
  <a href="advance-range.html" style="background:#ffb347;color:#003d52;">üìä Advance Range</a>
  <a href="budget-range.html">üí∞ Budget Range</a>
  <a href="sqft-range.html">üìê Sqft Range</a>
  <a href="negotiable-range.html">ü§ù Negotiable Range</a>
  <a href="location-report.html">üìç Location</a>
</nav>

<!-- ‚úÖ Filters -->
<div class="filters">
  <select id="yearFilter"><option value="All">All Years</option></select>
  <select id="monthFilter"><option value="All">All Months</option></select>
</div>

<!-- ‚úÖ Cards -->
<div class="cards">
  <div class="card"><h2 id="totalBookings">0</h2><p>Total Bookings</p></div>
  <div class="card"><h2 id="totalSqft">0</h2><p>Total Sq Ft</p></div>
  <div class="card"><h2 id="selectedYear">All</h2><p>Selected Year</p></div>
  <div class="card"><h2 id="selectedMonth">All</h2><p>Selected Month</p></div>
</div>

<h2>TEAM WISE & ADVANCE RANGE REPORT</h2>

<table id="dataTable">
  <thead>
    <tr>
      <th rowspan="2">Team Name</th>
      <th colspan="2">Overall</th>
      <th colspan="3">Below 5K</th>
      <th colspan="3">5K - 10K</th>
      <th colspan="3">10K - 25K</th>
      <th colspan="3">Above 25K</th>
    </tr>
    <tr>
      <th>Count</th><th>Sq Ft</th>
      <th>Count</th><th>Sq Ft</th><th>%</th>
      <th>Count</th><th>Sq Ft</th><th>%</th>
      <th>Count</th><th>Sq Ft</th><th>%</th>
      <th>Count</th><th>Sq Ft</th><th>%</th>
    </tr>
  </thead>
  <tbody></tbody>
  <tfoot></tfoot>
</table>

<div id="chartContainer"><canvas id="bookingsChart"></canvas></div>

<script>
let allData = [], monthsByYear = {}, chartInstance = null;

// ‚úÖ CSV path (GitHub Pages)
const CSV_URL = "https://nijannfbd7890.github.io/WRM/workbook.csv";

// ‚úÖ Load CSV
Papa.parse(CSV_URL, {
  download: true, header: true,
  complete: res => initDashboard(res.data)
});

// ‚úÖ Initialize Dashboard
function initDashboard(data) {
  const norm = s => s ? s.trim().toLowerCase() : "";
  const f = data[0];

  const teamKey = Object.keys(f).find(k => norm(k) === "team name");
  const advKey  = Object.keys(f).find(k => norm(k) === "advance range");
  const dateKey = Object.keys(f).find(k => norm(k) === "booking date");
  const sqftKey = Object.keys(f).find(k => norm(k).includes("actual total sq-ft"));

  console.log("Matched Columns ‚Üí", { teamKey, advKey, dateKey, sqftKey });

  if (!teamKey || !advKey || !sqftKey || !dateKey) {
    alert("‚ö† Missing required columns in CSV!");
    return;
  }

  allData = data.filter(d => d[teamKey]);
  populateFilters(allData, dateKey);
  updateDashboard("All", "All", teamKey, advKey, sqftKey, dateKey);

  document.getElementById("yearFilter").addEventListener("change", e => {
    updateMonthDropdown(e.target.value);
    updateDashboard(e.target.value, document.getElementById("monthFilter").value, teamKey, advKey, sqftKey, dateKey);
  });

  document.getElementById("monthFilter").addEventListener("change", e => {
    updateDashboard(document.getElementById("yearFilter").value, e.target.value, teamKey, advKey, sqftKey, dateKey);
  });
}

// ‚úÖ Year/Month Filters
function populateFilters(data, dateKey) {
  const years = []; monthsByYear = {};
  data.forEach(r => {
    const raw = (r[dateKey] || "").trim();
    if (!raw) return;
    const [d,m,y] = raw.split(/[-\/]/);
    if (!y) return;
    const year = parseInt(y);
    const mon = new Date(`${y}-${m}-01`).toLocaleString('en',{month:'short'}) + "-" + y.slice(-2);
    if(!years.includes(year)) years.push(year);
    if(!monthsByYear[year]) monthsByYear[year] = [];
    if(!monthsByYear[year].includes(mon)) monthsByYear[year].push(mon);
  });
  years.sort((a,b)=>b-a);
  const yearSel = document.getElementById("yearFilter");
  yearSel.innerHTML = '<option value="All">All</option>';
  years.forEach(y => yearSel.innerHTML += `<option>${y}</option>`);
  updateMonthDropdown("All");
}

function updateMonthDropdown(selectedYear) {
  const monthSel = document.getElementById("monthFilter");
  monthSel.innerHTML = '<option value="All">All</option>';
  if (selectedYear !== "All") {
    (monthsByYear[selectedYear]||[]).forEach(m => monthSel.innerHTML += `<option>${m}</option>`);
  } else {
    const allMonths = [...new Set(Object.values(monthsByYear).flat())];
    allMonths.forEach(m => monthSel.innerHTML += `<option>${m}</option>`);
  }
}

// ‚úÖ Update Table + Chart
function updateDashboard(year, month, teamKey, advKey, sqftKey, dateKey) {
  let filtered = allData.filter(r => r[dateKey]);
  if (year !== "All" || month !== "All") {
    filtered = filtered.filter(r => {
      const raw = (r[dateKey] || "").trim();
      const [d,m,y] = raw.split(/[-\/]/);
      if (!y) return false;
      const rowYear = parseInt(y);
      const rowMonth = new Date(`${y}-${m}-01`).toLocaleString('en',{month:'short'}) + "-" + y.slice(-2);
      if (year !== "All" && rowYear != year) return false;
      if (month !== "All" && rowMonth.toLowerCase() != month.toLowerCase()) return false;
      return true;
    });
  }

  const teams = {};
  filtered.forEach(r => {
    const team = (r[teamKey] || "Unknown").trim();
    const adv = (r[advKey] || "").toLowerCase();
    const sqft = parseFloat((r[sqftKey]||"0").replace(/,/g,"")) || 0;

    if (!teams[team]) {
      teams[team] = {
        totalCount: 0, totalSqft: 0,
        below5k:{count:0,sqft:0},
        fiveToTen:{count:0,sqft:0},
        tenToTwentyFive:{count:0,sqft:0},
        aboveTwentyFive:{count:0,sqft:0}
      };
    }
    const t = teams[team];
    t.totalCount++;
    t.totalSqft += sqft;

    if (adv.includes("below 5k")) { t.below5k.count++; t.below5k.sqft += sqft; }
    else if (adv.includes("5k") && adv.includes("10k")) { t.fiveToTen.count++; t.fiveToTen.sqft += sqft; }
    else if (adv.includes("10") && adv.includes("25")) { t.tenToTwentyFive.count++; t.tenToTwentyFive.sqft += sqft; }
    else if (adv.includes("above 25")) { t.aboveTwentyFive.count++; t.aboveTwentyFive.sqft += sqft; }
  });

  const sorted = Object.entries(teams).sort((a,b)=>b[1].totalCount - a[1].totalCount);

  const tbody = document.querySelector("#dataTable tbody");
  const tfoot = document.querySelector("#dataTable tfoot");
  tbody.innerHTML = ""; tfoot.innerHTML = "";
  const g = { totalCount:0, totalSqft:0, below5k:{count:0,sqft:0}, fiveToTen:{count:0,sqft:0}, tenToTwentyFive:{count:0,sqft:0}, aboveTwentyFive:{count:0,sqft:0} };
  const pct = (a,b)=>b?(Math.round(a/b*100)+"%"):"0%";

  sorted.forEach(([team,t])=>{
    g.totalCount+=t.totalCount; g.totalSqft+=t.totalSqft;
    g.below5k.count+=t.below5k.count; g.below5k.sqft+=t.below5k.sqft;
    g.fiveToTen.count+=t.fiveToTen.count; g.fiveToTen.sqft+=t.fiveToTen.sqft;
    g.tenToTwentyFive.count+=t.tenToTwentyFive.count; g.tenToTwentyFive.sqft+=t.tenToTwentyFive.sqft;
    g.aboveTwentyFive.count+=t.aboveTwentyFive.count; g.aboveTwentyFive.sqft+=t.aboveTwentyFive.sqft;

    tbody.insertAdjacentHTML("beforeend",`
      <tr>
        <td>${team}</td>
        <td>${t.totalCount}</td><td>${Math.round(t.totalSqft)}</td>
        <td>${t.below5k.count}</td><td>${Math.round(t.below5k.sqft)}</td><td>${pct(t.below5k.count,t.totalCount)}</td>
        <td>${t.fiveToTen.count}</td><td>${Math.round(t.fiveToTen.sqft)}</td><td>${pct(t.fiveToTen.count,t.totalCount)}</td>
        <td>${t.tenToTwentyFive.count}</td><td>${Math.round(t.tenToTwentyFive.sqft)}</td><td>${pct(t.tenToTwentyFive.count,t.totalCount)}</td>
        <td>${t.aboveTwentyFive.count}</td><td>${Math.round(t.aboveTwentyFive.sqft)}</td><td>${pct(t.aboveTwentyFive.count,t.totalCount)}</td>
      </tr>`);
  });

  tfoot.innerHTML = `
  <tr>
    <td>Grand Total</td>
    <td>${g.totalCount}</td><td>${Math.round(g.totalSqft)}</td>
    <td>${g.below5k.count}</td><td>${Math.round(g.below5k.sqft)}</td><td>${pct(g.below5k.count,g.totalCount)}</td>
    <td>${g.fiveToTen.count}</td><td>${Math.round(g.fiveToTen.sqft)}</td><td>${pct(g.fiveToTen.count,g.totalCount)}</td>
    <td>${g.tenToTwentyFive.count}</td><td>${Math.round(g.tenToTwentyFive.sqft)}</td><td>${pct(g.tenToTwentyFive.count,g.totalCount)}</td>
    <td>${g.aboveTwentyFive.count}</td><td>${Math.round(g.aboveTwentyFive.sqft)}</td><td>${pct(g.aboveTwentyFive.count,g.totalCount)}</td>
  </tr>`;

  document.getElementById("totalBookings").textContent = g.totalCount;
  document.getElementById("totalSqft").textContent = Math.round(g.totalSqft);
  document.getElementById("selectedYear").textContent = year;
  document.getElementById("selectedMonth").textContent = month;

  renderChart(sorted);
}

// ‚úÖ Chart
function renderChart(dataArr){
  const ctx=document.getElementById("bookingsChart").getContext("2d");
  if(chartInstance) chartInstance.destroy();
  if(!dataArr.length) return;

  const labels=dataArr.map(([t])=>t);
  const counts=dataArr.map(([_,v])=>v.totalCount);

  chartInstance=new Chart(ctx,{
    type:"bar",
    plugins:[ChartDataLabels],
    data:{
      labels,
      datasets:[{
        label:"Bookings",
        data:counts,
        backgroundColor:(ctx)=>{
          const c=ctx.chart.ctx,area=ctx.chart.chartArea;
          if(!area)return"#00cc99";
          const g=c.createLinearGradient(0,area.bottom,0,area.top);
          g.addColorStop(0,"#ff9933");
          g.addColorStop(1,"#009933");
          return g;
        },
        borderColor:"rgba(255,255,255,0.8)",
        borderWidth:1
      }]
    },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      plugins:{
        legend:{display:false},
        datalabels:{
          color:'white',
          anchor:'end',
          align:'start',
          font:{weight:'bold'},
          formatter:v=>v
        },
        title:{
          display:true,
          text:"Total Bookings per Team (Advance Range)",
          color:"white",
          font:{size:16,weight:'bold'}
        }
      },
      scales:{
        x:{ticks:{color:"white",autoSkip:false,maxRotation:45,minRotation:45}},
        y:{ticks:{color:"white"},beginAtZero:true}
      }
    }
  });
}
</script>

</body>
</html>
