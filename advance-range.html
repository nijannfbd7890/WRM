<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Advance Range Report | WRM Dashboard</title>

<!-- Libraries -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

<style>
body {
  background: linear-gradient(135deg, #015871, #01414d);
  font-family: "Segoe UI", sans-serif;
  color: white;
  text-align: center;
  margin: 0;
  padding: 0;
}

/* HEADER */
header {
  width: 100%;
  background: linear-gradient(90deg, #003d52, #026b8a);
  box-shadow: 0 2px 8px rgba(0,0,0,0.4);
}
.header-container {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 10px 40px;
}
.logo-left, .logo-right {
  height: 90px;
  width: 90px;
  border-radius: 50%;
  background-color: white;
  object-fit: cover;
  box-shadow: 0 0 10px rgba(0,0,0,0.3);
  border: 3px solid #fff;
}
.header-title {
  flex: 1;
  text-align: center;
  color: white;
}
.header-title h1 {
  font-size: 1.7rem;
  line-height: 1.5;
  margin: 0;
  font-weight: bold;
}
.header-title span {
  font-size: 1.3rem;
  color: #ffe082;
}

/* NAVIGATION */
nav {
  display: flex;
  justify-content: center;
  flex-wrap: wrap;
  gap: 15px;
  background: rgba(255,255,255,0.1);
  padding: 10px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.3);
}
nav a {
  color: white;
  text-decoration: none;
  font-weight: bold;
  background: #026b8a;
  padding: 8px 15px;
  border-radius: 6px;
  transition: 0.3s;
}
nav a:hover, nav a.active {
  background: #ffb347;
  color: #003d52;
}

/* FILTERS */
.filters { margin: 15px; }
select {
  padding: 8px; margin: 0 8px;
  border-radius: 5px; font-size: 1rem;
}

/* DASHBOARD CARDS */
.cards {
  display: flex;
  justify-content: center;
  flex-wrap: wrap;
  gap: 20px;
  margin: 25px;
}
.card {
  background: #256371;
  border-radius: 18px;
  padding: 25px;
  min-width: 200px;
  width: 230px;
  box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
  transition: transform 0.3s ease, box-shadow 0.3s ease;
}
.card:hover {
  transform: translateY(-5px);
  box-shadow: 0 10px 25px rgba(0, 0, 0, 0.4);
}
.card h2 {
  margin: 0;
  font-size: 2.2rem;
  font-weight: 700;
  color: #ffde59;
}
.card p {
  margin-top: 8px;
  font-size: 1rem;
  color: white;
}

/* TABLE */
table {
  width: 95%;
  margin: 15px auto;
  border-collapse: collapse;
  font-size: 0.9rem;
  text-align: center;
}
th, td {
  padding: 8px;
  border: 1px solid rgba(255,255,255,0.2);
}
th {
  background-color: rgba(255,255,255,0.2);
}
tfoot tr {
  background-color: rgba(255,255,255,0.3);
  font-weight: bold;
}

/* CHART */
#chartContainer {
  width: 90%;
  max-width: 1000px;
  margin: 25px auto;
  height: 400px;
  background: rgba(255,255,255,0.05);
  border-radius: 12px;
  padding: 15px;
  box-shadow: 0 0 10px rgba(255,255,255,0.2);
}
canvas {
  width: 100% !important;
  height: 100% !important;
}
</style>
</head>

<body>
<header>
  <div class="header-container">
    <img src="LOGO.png" alt="Company Logo" class="logo-left" />
    <div class="header-title">
      <h1>
        Namma Family Builder and Developer Pvt. Ltd<br>
        WRM Report Analysis Dashboard<br>
        <span>Team - Marketing Management</span>
      </h1>
    </div>
    <img src="cs.jpg" alt="Boss Photo" class="logo-right" />
  </div>
</header>

<nav>
  <a href="index.html">üè† Dashboard</a>
  <a href="advance-range.html" class="active">üìä Advance Range</a>
  <a href="budget-range.html">üí∞ Budget Range</a>
  <a href="sqft-range.html">üìê Sqft Range</a>
  <a href="negotiable-range.html">ü§ù Negotiable Range</a>
  <a href="location-report.html">üìç Location</a>
</nav>

<div class="filters">
  <select id="yearFilter"><option value="All">All Years</option></select>
  <select id="monthFilter"><option value="All">All Months</option></select>
</div>

<div class="cards">
  <div class="card"><h2 id="totalBookings">0</h2><p>Total Bookings</p></div>
  <div class="card"><h2 id="totalSqft">0</h2><p>Total Sq Ft</p></div>
  <div class="card"><h2 id="selectedYear">All</h2><p>Selected Year</p></div>
  <div class="card"><h2 id="selectedMonth">All</h2><p>Selected Month</p></div>
</div>

<h2>TEAM WISE & ADVANCE RANGE REPORT</h2>

<table id="dataTable">
  <thead>
    <tr>
      <th rowspan="2">Team Name</th>
      <th colspan="2">Overall</th>
      <th colspan="3">Below 5K</th>
      <th colspan="3">5K - 10K</th>
      <th colspan="3">10K - 25K</th>
      <th colspan="3">Above 25K</th>
    </tr>
    <tr>
      <th>Count</th><th>Sq Ft</th>
      <th>Count</th><th>Sq Ft</th><th>%</th>
      <th>Count</th><th>Sq Ft</th><th>%</th>
      <th>Count</th><th>Sq Ft</th><th>%</th>
      <th>Count</th><th>Sq Ft</th><th>%</th>
    </tr>
  </thead>
  <tbody></tbody>
  <tfoot></tfoot>
</table>

<div id="chartContainer">
  <canvas id="bookingsChart"></canvas>
</div>

<script>
let allData = [], monthsByYear = {}, chartInstance = null;

// ‚úÖ Normalize team names
const TEAM_CANONICAL = {
  "suriya sir & selvakumar sir": "Suriya Sir & Selvakumar Sir",
  "suriya sir": "Suriya Sir & Selvakumar Sir",
  "selvakumar sir": "Suriya Sir & Selvakumar Sir",
  "latha mam & ayyappan sir": "Latha Mam & Ayyappan Sir",
  "latha mam": "Latha Mam & Ayyappan Sir",
  "ayyappan sir": "Latha Mam & Ayyappan Sir"
};

function titleCase(str) {
  return (str || "").toLowerCase()
    .split(" ")
    .map(w => w.charAt(0).toUpperCase() + w.slice(1))
    .join(" ");
}

function normalizeTeamName(name) {
  const key = (name || "").toLowerCase().trim();
  return TEAM_CANONICAL[key] || titleCase(name || "Unknown");
}

Papa.parse("https://nijannfbd7890.github.io/Team_Report_Dashboard/workbook.csv", {
  download: true,
  header: true,
  complete: res => {
    allData = res.data.filter(d => d && Object.keys(d).length > 0);
    console.log("‚úÖ CSV Loaded Rows:", allData.length);
    initDashboard();
  }
});

function findKeyLike(row, keyword) {
  const norm = s => s.toLowerCase().replace(/\s+/g, " ");
  return Object.keys(row).find(k => norm(k).includes(keyword));
}

function initDashboard() {
  if (!allData.length) {
    alert("‚ö†Ô∏è CSV has no readable rows");
    return;
  }

  const sample = allData[0];
  const teamKey = findKeyLike(sample, "team");
  const advKey  = findKeyLike(sample, "advance");
  const sqftKey = findKeyLike(sample, "sq");
  const dateKey = findKeyLike(sample, "book");

  console.log("Detected Columns ‚Üí", { teamKey, advKey, sqftKey, dateKey });
  if (!teamKey || !advKey || !sqftKey || !dateKey) {
    alert("‚ö† Missing required columns in CSV!");
    return;
  }

  populateFilters(dateKey);
  updateDashboard("All", "All", teamKey, advKey, sqftKey, dateKey);
}

function populateFilters(dateKey) {
  const years = new Set();
  const months = {};
  allData.forEach(r => {
    const raw = (r[dateKey] || "").trim();
    const [d, m, y] = raw.split(/[-\/]/);
    if (!y) return;
    const year = parseInt(y);
    const month = new Date(`${y}-${m}-01`).toLocaleString('en', { month: 'short' }) + "-" + y.slice(-2);
    years.add(year);
    if (!months[year]) months[year] = [];
    if (!months[year].includes(month)) months[year].push(month);
  });

  const yearSel = document.getElementById("yearFilter");
  yearSel.innerHTML = '<option value="All">All Years</option>' +
    Array.from(years).sort((a,b)=>b-a).map(y=>`<option>${y}</option>`).join("");

  const monthSel = document.getElementById("monthFilter");
  monthSel.innerHTML = '<option value="All">All Months</option>';

  yearSel.onchange = e => updateDashboard(e.target.value, monthSel.value);
  monthSel.onchange = e => updateDashboard(yearSel.value, e.target.value);
}

function updateDashboard(year, month, teamKey, advKey, sqftKey, dateKey) {
  let filtered = allData.filter(r => r[dateKey]);
  if (year !== "All" || month !== "All") {
    filtered = filtered.filter(r => {
      const raw = (r[dateKey] || "").trim();
      const [d, m, y] = raw.split(/[-\/]/);
      if (!y) return false;
      const rowYear = parseInt(y);
      const rowMonth = new Date(`${y}-${m}-01`).toLocaleString('en', { month: 'short' }) + "-" + y.slice(-2);
      return (year === "All" || rowYear == year) && (month === "All" || rowMonth.toLowerCase() === month.toLowerCase());
    });
  }

  console.log("üìä Filtered Rows:", filtered.length);
  if (!filtered.length) {
    renderChart({});
    return;
  }

  const teams = {};
  filtered.forEach(r => {
    const team = normalizeTeamName(r[teamKey]);
    const adv = (r[advKey] || "").toLowerCase();
    const sqft = parseFloat((r[sqftKey] || "0").replace(/,/g, "")) || 0;

    if (!teams[team]) teams[team] = { totalCount:0, totalSqft:0 };
    teams[team].totalCount++;
    teams[team].totalSqft += sqft;
  });

  renderChart(teams);
}

function renderChart(teams) {
  const ctx = document.getElementById("bookingsChart").getContext("2d");
  if (chartInstance) chartInstance.destroy();

  const labels = Object.keys(teams);
  const data = Object.values(teams).map(t => t.totalCount);

  console.log("üìà Chart Data:", labels, data);
  if (!labels.length) return;

  chartInstance = new Chart(ctx, {
    type: "bar",
    plugins: [ChartDataLabels],
    data: {
      labels,
      datasets: [{
        label: "Bookings Count",
        data,
        backgroundColor: "#ffb347",
        borderColor: "#fff",
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        datalabels: {
          color: "#fff", anchor: "end", align: "top", font: { weight: "bold" }
        },
        title: {
          display: true, text: "Total Bookings per Team", color: "#fff"
        }
      },
      scales: {
        x: { ticks: { color: "#fff" } },
        y: { ticks: { color: "#fff" }, beginAtZero: true }
      }
    }
  });
}
</script>

</body>
</html>