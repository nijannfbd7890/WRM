<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Advance Range | WRM Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<!-- ===== REQUIRED LIBRARIES for PDF Download ===== -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<!-- =============================================== -->

<style>
  body {
    background: linear-gradient(135deg, #015871, #01414d);
    font-family: "Segoe UI", sans-serif;
    color: white;
    text-align: center;
    margin: 0;
  }
/* ========== HEADER SECTION (LOGO + TITLE + BOSS IMAGE) ========== */
header {
  width: 100%;
  background: linear-gradient(90deg, #003d52, #026b8a);
  box-shadow: 0 2px 8px rgba(0,0,0,0.4);
}
.header-container {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 10px 50px;
}
.logo-left, .logo-right {
  height: 85px;
  width: 85px;
  border-radius: 50%;
  background-color: white;
  object-fit: cover;
  box-shadow: 0 0 10px rgba(0,0,0,0.3);
  border: 3px solid #fff;
}
.boss-container {
  position: relative;
  display: inline-block;
}

/* Tooltip styling */
.boss-tooltip {
  visibility: hidden;
  background-color: rgba(0, 0, 0, 0.8);
  color: #fff;
  text-align: center;
  padding: 6px 10px;
  border-radius: 6px;
  position: absolute;
  bottom: -35px;
  left: 50%;
  transform: translateX(-50%);
  white-space: nowrap;
  font-size: 0.9rem;
  font-weight: 500;
  opacity: 0;
  transition: opacity 0.3s ease;
  z-index: 10;
}

/* Show on hover */
.boss-container:hover .boss-tooltip {
  visibility: visible;
  opacity: 1;
}

.header-title {
  flex: 1;
  text-align: center;
  color: white;
}
.header-title h1 {
  font-size: 1.8rem;
  line-height: 1.5;
  margin: 0;
  font-weight: bold;
}
.header-title span {
  font-size: 1.2rem;
  color: #ffde59;
  font-weight: 600;
}
 /* HEADER */
header {
  width: 100%;
  background: linear-gradient(90deg, #003d52, #026b8a);
  box-shadow: 0 2px 8px rgba(0,0,0,0.4);
}
 .header-container {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 10px 50px;
}
.logo-left, .logo-right {
  height: 85px;
  width: 85px;
  border-radius: 50%;
  background-color: white;
  object-fit: cover;
  box-shadow: 0 0 10px rgba(0,0,0,0.3);
  border: 3px solid #fff;
}
  .header-title {
    flex: 1;
    text-align: center;
    color: white;
  }
  .header-title h1 {
    margin: 0;
    font-size: 1.6rem;
    line-height: 1.4;
  }
  .header-title span {
    font-size: 1.2rem;
    color: #ffd666;
  }

  /* NAV BAR */
  nav {
    display: flex;
    justify-content: center;
    gap: 15px;
    background: rgba(0,0,0,0.18);
    padding: 10px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.3);
  }
  nav a {
    color: white;
    text-decoration: none;
    font-weight: 600;
    background: #026b8a;
    padding: 8px 18px;
    border-radius: 999px;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    font-size: 0.98rem;
    transition: 0.25s;
  }
  nav a:hover {
    background: #ffb347;
    color: #003d52;
  }
  nav a.active {
    background: #ffb347;
    color: #003d52;
    box-shadow: 0 0 10px rgba(0,0,0,0.4);
  }

  /* FILTERS + CARDS */
  .filters {
    margin: 18px 0 5px;
  }
  select {
    padding: 8px 14px;
    margin: 0 6px;
    border-radius: 8px;
    border: none;
    font-size: 1rem;
  }

  .cards {
    display: flex;
    justify-content: center;
    flex-wrap: wrap;
    gap: 18px;
    margin: 12px 15px 25px;
  }
  .card {
    background: rgba(255,255,255,0.12);
    border-radius: 18px;
    padding: 20px 30px;
    min-width: 220px;
    box-shadow: 0 4px 14px rgba(0,0,0,0.35);
  }
  .card h2 {
    margin: 0;
    font-size: 2.3rem;
    color: #ffd666;
  }
  .card p {
    margin: 6px 0 0;
    font-size: 1rem;
    opacity: 0.9;
  }

  /* TABLE */
  table {
    width: 95%;
    margin: 0 auto 18px;
    border-collapse: collapse;
    font-size: 0.9rem;
    text-align: center;
  }
  th, td {
    padding: 8px;
    border: 1px solid rgba(255,255,255,0.18);
  }
  th {
    background-color: rgba(255,255,255,0.18);
  }
  tfoot tr {
    background-color: rgba(255,255,255,0.3);
    font-weight: bold;
  }

  h2.section-title {
    margin-top: 0;
    margin-bottom: 12px;
  }

  /* CHART */
  #chartContainer {
    width: 92%;
    max-width: 1300px;
    margin: 12px auto 30px;
    height: 420px;
    background: rgba(0,0,0,0.18);
    border-radius: 22px;
    padding: 18px;
    box-shadow: 0 0 12px rgba(0,0,0,0.45);
  }
  #######FOR YEARS AND MONTH###############
/* ==========================================
   FOR YEARS AND MONTH ‚Äî FILTER STYLING
   ========================================== */
<!-- .filters { -->
  <!-- margin: 18px 0 5px; -->
<!-- } -->

/* Slightly move the filter box downward */
.filters {
  margin-top: 38px;     /* increased top margin for downward shift */
  margin-bottom: 10px;  /* keeps space before the cards */
}


/* Beautify Year & Month dropdowns */
.filters select {
  appearance: none;
  -webkit-appearance: none;
  -moz-appearance: none;
  background-color: #015871;
  color: #ffd666;
  font-weight: bold;
  padding: 10px 36px 10px 16px;
  border: 2px solid #00a8b5;
  border-radius: 10px;
  font-size: 1rem;
  cursor: pointer;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
  transition: all 0.25s ease;
}

/* Custom arrow (just a little decorative icon) */
.filters select::after {
  content: "‚ñº";
  position: absolute;
  right: 10px;
  top: 50%;
  transform: translateY(-50%);
  pointer-events: none;
}

/* Hover and focus states */
.filters select:hover {
  background-color: #02798f;
  border-color: #ffd666;
}
.filters select:focus {
  outline: none;
  box-shadow: 0 0 8px #ffd666;
}

/* Container background behind both dropdowns */
.filter-box {
  display: inline-flex;
  gap: 10px;
  background: rgba(255, 255, 255, 0.08);
  padding: 10px 20px;
  border-radius: 12px;
  backdrop-filter: blur(2px);
}

#########################################
  canvas { width: 100% !important; height: 100% !important; }
/* --- Uniform filter dropdown style for all dashboards --- */
.filters {
  margin-top: 38px; /* same vertical spacing as main dashboard */
  display: flex;
  justify-content: center;
  gap: 15px;
}

.filters select {
  background-color: #026b8a;
  color: #ffd666;
  font-weight: bold;
  border: 2px solid #00b4b4;
  border-radius: 10px;
  padding: 12px 24px;
  font-size: 1rem;
  cursor: pointer;
  transition: all 0.3s ease;
  text-align: center;
  appearance: none;
}

.filters select:hover {
  background-color: #038ba8;
  border-color: #ffd666;
  transform: scale(1.05);
}

.filters select:focus {
  outline: none;
  box-shadow: 0 0 8px #ffd666;
}
  
  
  
</style>
</head>
<body>
<!-- <header> -->
  <!-- <div class="header-container"> -->
    <!-- <img src="LOGO.png" alt="Company Logo" class="logo-left" /> -->
    <!-- <div class="header-title"> -->
      <!-- <h1> -->
        <!-- Namma Family Builder and Developer Pvt. Ltd<br> -->
        <!-- WRM Report Analysis Dashboard<br> -->
        <!-- <span>Team - Marketing Management</span> -->
      <!-- </h1> -->
    <!-- </div> -->
    <!-- <img src="cs.jpg" alt="Boss Photo" class="logo-right" /> -->
  <!-- </div> -->
<!-- </header> -->
<!-- ========== HEADER ========== -->
<header>
  <div class="header-container">
    <!-- Left Logo -->
    <!-- <img src="LOGO.png" alt="Company Logo" class="logo-left" /> -->
	<div class="boss-container">
	  <!-- <img src="LOGO.png" alt="Company Logo" class="logo-left" /> -->
	  <!-- <img src="LOGO.png" alt="Company Logo" class="logo-left" crossorigin="anonymous" /> -->
		  <img 
	  src="https://raw.githubusercontent.com/nijannfbd7890/WRM/main/LOGO.png" 
	  alt="Company Logo" 
	  class="logo-left" 
	  crossorigin="anonymous"
	/>
	  <span class="boss-tooltip">NFBD</span>
	</div>

    <!-- Center Title -->
    <div class="header-title">
      <h1>
        Namma Family Builder and Developer Pvt. Ltd<br>
        WRM Report Analysis Dashboard<br>
        <span>Team - Marketing Management</span>
      </h1>
    </div>
	<!-- Right Boss Image -->
    <div class="boss-container">
	  <!-- <img src="cs.jpg" alt="Boss Photo" class="logo-right" /> -->
	  <!-- <img src="cs.jpg" alt="Boss Photo" class="logo-right" crossorigin="anonymous" /> -->
	  <img 
	  src="https://raw.githubusercontent.com/nijannfbd7890/WRM/main/cs.jpg" 
	  alt="Boss Photo" 
	  class="logo-right" 
	  crossorigin="anonymous"
	/>
	  <span class="boss-tooltip">Mr.Ponnusamy Karthik Sir</span>
	</div>

  </div>
	</header>

<nav>
  <a href="index.html">üè† Dashboard</a>
  <a href="advance-range.html" class="active">üìä Advance Range</a>
  <a href="budget-range.html">üí∞ Budget Range</a>
  <a href="sqft-range.html">üìê Sqft Range</a>
  <a href="negotiable-range.html">ü§ù Negotiable Range</a>
  <a href="location-report.html">üìç Location</a>
</nav>
<div class="filters">
  <select id="yearFilter"><option value="All">All Years</option></select>
  <select id="monthFilter"><option value="All">All Months</option></select>
</div>

<div class="cards">
  <!-- üîß FIXED: id was wrong, now correct: totalBookings -->
  <div class="card"><h2 id="totalBookings">0</h2><p>Total Bookings</p></div>
  <div class="card"><h2 id="totalSqft">0</h2><p>Total Sq Ft</p></div>
  <div class="card"><h2 id="selectedYear">All</h2><p>Selected Year</p></div>
  <div class="card"><h2 id="selectedMonth">All</h2><p>Selected Month</p></div>
</div>

<h2 class="section-title">TEAM WISE & ADVANCE RANGE REPORT</h2>

<table id="dataTable">
  <thead>
    <tr>
      <th rowspan="2">Team Name</th>
      <th colspan="2">Overall</th>
      <th colspan="3">Below 5K</th>
      <th colspan="3">5-10K</th>
      <th colspan="3">10-25K</th>
      <th colspan="3">25-50K</th>
      <th colspan="3">Above 50K</th>
    </tr>
    <tr>
      <th>Count</th><th>Sq Ft</th>
      <th>Count</th><th>Sq Ft</th><th>%</th>
      <th>Count</th><th>Sq Ft</th><th>%</th>
      <th>Count</th><th>Sq Ft</th><th>%</th>
      <th>Count</th><th>Sq Ft</th><th>%</th>
      <th>Count</th><th>Sq Ft</th><th>%</th>
    </tr>
  </thead>
  <tbody></tbody>
  <tfoot></tfoot>
</table>

<div id="chartContainer">
  <canvas id="bookingsChart"></canvas>
</div>
<div style="text-align:right; margin:10px 25px;">
  <button id="downloadBtn" style="
    background:#ffb347; 
    color:#003d52; 
    font-weight:600; 
    border:none; 
    border-radius:8px; 
    padding:8px 16px; 
    cursor:pointer;
    box-shadow:0 2px 6px rgba(0,0,0,0.3);
  ">
    ‚¨áÔ∏è Download PDF
  </button>
</div>
<!-- ========== FOOTER ========== -->
<footer>
  ¬© 2025 Namma Family Builder & Developer Pvt. Ltd ‚Äî All Rights Reserved
</footer>

<script>
let allData = [], monthsByYear = {}, chartInstance = null;

/* Canonical team mapping so names don't split */
const TEAM_CANONICAL = {
  "suriya sir & selvakumar sir": "Suriya Sir & Selvakumar Sir",
  "suriya sir": "Suriya Sir & Selvakumar Sir",
  "selvakumar sir": "Suriya Sir & Selvakumar Sir",
  "latha mam & ayyappan sir": "Latha Mam & Ayyappan Sir",
  "latha mam": "Latha Mam & Ayyappan Sir",
  "ayyappan sir": "Latha Mam & Ayyappan Sir"
};
// ‚úÖ Master list of live teams (even if no bookings in CSV)
const MASTER_TEAMS = [
  "Ranjith Sir",
  "Suriya Sir & Selvakumar Sir",
  "Latha Mam & Ayyappan Sir",
  "Prabhakaran Sir",
  "Ashok Sir",
  "Rajiv Sir",
  "Gopi Sir",
  "Thangadurai Sir",
  "Senthil Sir",
  "Kumaresan Sir",   // üîπ No booking this month
  "Sankar Sir"       // üîπ No booking this month
];


function titleCase(str) {
  if (!str) return "";
  return str
    .toLowerCase()
    .replace(/\s*&\s*/g," & ")
    .split(" ")
    .filter(w => w.trim() !== "")
    .map(w => w.charAt(0).toUpperCase() + w.slice(1))
    .join(" ")
    .trim();
}
function normalizeTeamName(value) {
  let raw = (value || "Unknown").trim();
  let key = raw.toLowerCase().replace(/\s*&\s*/g," & ").replace(/\s+/g," ").trim();
  return TEAM_CANONICAL[key] || titleCase(key);
}

/* Load CSV */
Papa.parse("https://nijannfbd7890.github.io/WRM/workbook.csv",{
  download:true,
  header:true,
  complete: res => initDashboard(res.data)
});

function initDashboard(data){
  const norm = s => s ? s.trim().toLowerCase() : "";
  const f = data[0];

  const teamKey = Object.keys(f).find(k => norm(k) === "team name");
  const advKey  = Object.keys(f).find(k => norm(k).includes("advance range"));
  const dateKey = Object.keys(f).find(k => norm(k).includes("booking date"));

  if (!teamKey || !advKey || !dateKey) {
    alert("‚ö† Missing TEAM NAME / ADVANCE RANGE / BOOKING DATE in CSV");
    return;
  }

  allData = data.filter(d => d[teamKey]);

  // Expose filters
  window.yearFilter  = document.getElementById("yearFilter");
  window.monthFilter = document.getElementById("monthFilter");

  populateFilters(allData,dateKey);
  updateDashboard("All","All",teamKey,advKey,dateKey);

  yearFilter.addEventListener("change",e => {
    updateMonthDropdown(e.target.value);
    updateDashboard(e.target.value, monthFilter.value, teamKey, advKey, dateKey);
  });
  monthFilter.addEventListener("change",e => {
    updateDashboard(yearFilter.value, e.target.value, teamKey, advKey, dateKey);
  });
}

function populateFilters(data,dateKey){
  const years=[]; monthsByYear={};
  data.forEach(r=>{
    const raw=(r[dateKey]||"").trim();
    if(!raw) return;
    const [d,m,y]=raw.split(/[-\/]/);
    if(!y) return;
    const year=parseInt(y,10);
    const mon = new Date(`${y}-${m}-01`).toLocaleString('en',{month:'short'})+"-"+y.slice(-2);
    if(!years.includes(year)) years.push(year);
    if(!monthsByYear[year]) monthsByYear[year]=[];
    if(!monthsByYear[year].includes(mon)) monthsByYear[year].push(mon);
  });
  years.sort((a,b)=>b-a);
  const yearSel = yearFilter;
  yearSel.innerHTML='<option value="All">All Years</option>';
  years.forEach(y=>yearSel.innerHTML+=`<option>${y}</option>`);
  updateMonthDropdown("All");
}

function updateMonthDropdown(selectedYear){
  const monthSel = monthFilter;
  monthSel.innerHTML = '<option value="All">All Months</option>';
  if(selectedYear!=="All"){
    (monthsByYear[selectedYear]||[]).forEach(m=>monthSel.innerHTML+=`<option>${m}</option>`);
  }else{
    const allMonths=[...new Set(Object.values(monthsByYear).flat())];
    allMonths.forEach(m=>monthSel.innerHTML+=`<option>${m}</option>`);
  }
}


function updateDashboard(year,month,teamKey,advKey,dateKey){
  //let filtered = allData.filter(r=>r[dateKey]);
  window.filtered = allData.filter(r=>r[dateKey]);
  if(year!=="All" || month!=="All"){
    filtered = filtered.filter(r=>{
      const raw=(r[dateKey]||"").trim();
      const [d,m,y]=raw.split(/[-\/]/);
      if(!y) return false;
      const rowYear=parseInt(y,10);
      const rowMonth=new Date(`${y}-${m}-01`).toLocaleString('en',{month:'short'})+"-"+y.slice(-2);
      if(year!=="All" && rowYear!=year) return false;
      if(month!=="All" && rowMonth.toLowerCase()!=month.toLowerCase()) return false;
      return true;
    });
  }
  // ‚úÖ Get ALL unique teams from full data (even zero booking teams)
const allTeams = MASTER_TEAMS.map(t => normalizeTeamName(t));



  //const teams={};
  // ‚úÖ Initialize all teams with zero values
const teams = {};
allTeams.forEach(team => {
  teams[team] = {
    totalCount: 0,
    totalSqft: 0,
    below5k: { count: 0, sqft: 0 },
    fiveToTen: { count: 0, sqft: 0 },
    tenToTwentyFive: { count: 0, sqft: 0 },
    twentyFiveToFifty: { count: 0, sqft: 0 },
    aboveFifty: { count: 0, sqft: 0 }
  };
});

  
  filtered.forEach(r => {
  const team = normalizeTeamName(r[teamKey]);
  const adv  = (r[advKey] || "").toLowerCase();

  let sqft = 0;
  Object.keys(r).forEach(k => {
    if (k.toLowerCase().startsWith("actual total sq-ft")) {
      const v = parseFloat((r[k] + "").replace(/,/g, ""));
      if (!isNaN(v)) sqft += v;
    }
  });

  const t = teams[team]; // ‚úÖ team already exists

  t.totalCount++;
  t.totalSqft += sqft;

  if (adv.includes("below 5k")) {
    t.below5k.count++; t.below5k.sqft += sqft;
  } else if (adv.includes("5k") && adv.includes("10k")) {
    t.fiveToTen.count++; t.fiveToTen.sqft += sqft;
  } else if (adv.includes("10") && adv.includes("25")) {
    t.tenToTwentyFive.count++; t.tenToTwentyFive.sqft += sqft;
  } else if (
    (adv.includes("25") && adv.includes("50")) || adv.includes("25-50")
  ) {
    t.twentyFiveToFifty.count++; t.twentyFiveToFifty.sqft += sqft;
  } else if (adv.includes("above 50") || adv.includes(">50")) {
    t.aboveFifty.count++; t.aboveFifty.sqft += sqft;
  }
});


	const sorted = Object.entries(teams).sort((a, b) => {
  if (b[1].totalSqft === 0 && a[1].totalSqft === 0) {
    return a[0].localeCompare(b[0]); // alphabetical for zero teams
  }
  if (b[1].totalSqft === 0) return -1;
  if (a[1].totalSqft === 0) return 1;
  return b[1].totalSqft - a[1].totalSqft;
});



  const tbody=document.querySelector("#dataTable tbody");
  const tfoot=document.querySelector("#dataTable tfoot");
  tbody.innerHTML=""; tfoot.innerHTML="";

  let g = {
    totalCount:0,totalSqft:0,
    below5k:{count:0,sqft:0},
    fiveToTen:{count:0,sqft:0},
    tenToTwentyFive:{count:0,sqft:0},
    twentyFiveToFifty:{count:0,sqft:0},
	aboveFifty:{count:0,sqft:0}

  };
  //const pct=(p,t)=> t ? Math.round((p/t)*100)+"%" : "0%";
  const pct = (rangeSqft, totalSqft) =>
  totalSqft ? Math.round((rangeSqft / totalSqft) * 100) + "%" : "0%";


  sorted.forEach(([team,t])=>{
    g.totalCount += t.totalCount;
    g.totalSqft  += t.totalSqft;
    g.below5k.count += t.below5k.count; g.below5k.sqft += t.below5k.sqft;
    g.fiveToTen.count += t.fiveToTen.count; g.fiveToTen.sqft += t.fiveToTen.sqft;
    g.tenToTwentyFive.count += t.tenToTwentyFive.count; g.tenToTwentyFive.sqft += t.tenToTwentyFive.sqft;
    g.twentyFiveToFifty.count += t.twentyFiveToFifty.count;g.twentyFiveToFifty.sqft  += t.twentyFiveToFifty.sqft;g.aboveFifty.count += t.aboveFifty.count;g.aboveFifty.sqft  += t.aboveFifty.sqft;

    tbody.insertAdjacentHTML("beforeend",`
      <tr>
        <td>${team}</td>
        <td>${t.totalCount}</td><td>${Math.round(t.totalSqft)}</td>
        <td>${t.below5k.count}</td><td>${Math.round(t.below5k.sqft)}</td><td>${pct(t.below5k.sqft, t.totalSqft)}</td>
        <td>${t.fiveToTen.count}</td><td>${Math.round(t.fiveToTen.sqft)}</td><td>${pct(t.fiveToTen.sqft, t.totalSqft)}</td>
        <td>${t.tenToTwentyFive.count}</td><td>${Math.round(t.tenToTwentyFive.sqft)}</td><td>${pct(t.tenToTwentyFive.sqft, t.totalSqft)}</td>
        <td>${t.twentyFiveToFifty.count}</td><td>${Math.round(t.twentyFiveToFifty.sqft)}</td><td>${pct(t.twentyFiveToFifty.sqft, t.totalSqft)}</td>
		<td>${t.aboveFifty.count}</td><td>${Math.round(t.aboveFifty.sqft)}</td><td>${pct(t.aboveFifty.sqft, t.totalSqft)}</td>

      </tr>
    `);
	
  });

  tfoot.innerHTML = `
    <tr>
      <td>Grand Total</td>
      <td>${g.totalCount}</td><td>${Math.round(g.totalSqft)}</td>
      <td>${g.below5k.count}</td><td>${Math.round(g.below5k.sqft)}</td><td>${pct(g.below5k.sqft, g.totalSqft)}</td>
      <td>${g.fiveToTen.count}</td><td>${Math.round(g.fiveToTen.sqft)}</td><td>${pct(g.fiveToTen.sqft, g.totalSqft)}</td>
      <td>${g.tenToTwentyFive.count}</td><td>${Math.round(g.tenToTwentyFive.sqft)}</td><td>${pct(g.tenToTwentyFive.sqft, g.totalSqft)}</td>
      <td>${g.twentyFiveToFifty.count}</td><td>${Math.round(g.twentyFiveToFifty.sqft)}</td><td>${pct(g.twentyFiveToFifty.sqft, g.totalSqft)}</td>
	  <td>${g.aboveFifty.count}</td><td>${Math.round(g.aboveFifty.sqft)}</td><td>${pct(g.aboveFifty.sqft, g.totalSqft)}</td>
    </tr>
  `;

  document.getElementById("totalBookings").textContent = g.totalCount;
  document.getElementById("totalSqft").textContent     = Math.round(g.totalSqft);
  document.getElementById("selectedYear").textContent  = year;
  document.getElementById("selectedMonth").textContent = month;

  renderChart(sorted);
}

function renderChart(dataArr){
  const ctx=document.getElementById("bookingsChart").getContext("2d");
  if(chartInstance) chartInstance.destroy();
  if(!dataArr.length) return;

  const labels=dataArr.map(([t])=>t);
  const counts=dataArr.map(([_,v])=>v.totalCount);

  chartInstance = new Chart(ctx,{
    type:"bar",
    plugins:[ChartDataLabels],
    data:{
      labels,
      datasets:[{
        label:"Bookings",
        data:counts,
        backgroundColor:(ctx)=>{
          const c=ctx.chart.ctx,area=ctx.chart.chartArea;
          if(!area) return "#ffb347";
          const g=c.createLinearGradient(0,area.bottom,0,area.top);
          g.addColorStop(0,"#ffb347");
          g.addColorStop(1,"#00a86b");
          return g;
        },
        borderColor:"rgba(255,255,255,0.9)",
        borderWidth:1
      }]
    },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      plugins:{
        legend:{display:false},
        datalabels:{
          color:"white",
          anchor:"end",
          align:"start",
          font:{weight:"bold"},
          formatter:v=>v
        },
        title:{
          display:true,
          text:"Total Bookings per Team (Advance Range)",
          color:"white"
        }
      },
      scales:{
        x:{ticks:{color:"white",autoSkip:false,maxRotation:45,minRotation:45}},
        y:{ticks:{color:"white"},beginAtZero:true}
      }
    }
  });
}
</script>
<script>
document.getElementById("downloadBtn").addEventListener("click", async () => {
  const { jsPDF } = window.jspdf;
  const btn = document.getElementById("downloadBtn");
  const tooltips = document.querySelectorAll(".boss-tooltip");

  btn.style.visibility = "hidden";
  tooltips.forEach(t => t.style.display = "none");

  const dashboard = document.body;

  await html2canvas(dashboard, {
    scale: 1.2,
    useCORS: true,
    allowTaint: false, /* ‚úÖ Prevents tainted canvas error */
    backgroundColor: "#01414d"
  }).then(canvas => {
    const imgData = canvas.toDataURL("image/jpeg", 0.6);
    const pdf = new jsPDF("l", "mm", "a4");
    const pageWidth = pdf.internal.pageSize.getWidth();
    const pageHeight = pdf.internal.pageSize.getHeight();
    const imgWidth = pageWidth;
    const imgHeight = (canvas.height * pageWidth) / canvas.width;
    pdf.addImage(imgData, "JPEG", 0, 0, imgWidth, imgHeight);
    pdf.setFontSize(10);
    pdf.setTextColor(100);
    const timestamp = new Date().toLocaleString();
    pdf.text(`Generated on: ${timestamp}`, 10, pageHeight - 5);
    pdf.save("WRM_Dashboard.pdf");
  }).catch(err => {
    alert("‚ùå Error generating PDF: " + err);
  }).finally(() => {
    btn.style.visibility = "visible";
    tooltips.forEach(t => t.style.display = "");
  });
});
</script>

</body>
</html>