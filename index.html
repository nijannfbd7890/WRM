<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>WRM Report Analysis Dashboard</title>

<!-- ========== SCRIPT LIBRARIES ========== -->
<!-- Chart.js ‚Üí Used for creating charts -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- Chart.js plugin ‚Üí Adds labels on the bars -->
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
<!-- PapaParse ‚Üí Used to read CSV files directly from GitHub -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

<!-- For PDF export -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>


<style>
/* ========== PAGE STYLING ========== */
body {
  background: linear-gradient(135deg, #015871, #01414d);
  font-family: "Segoe UI", sans-serif;
  color: white;
  text-align: center;
  margin: 0;
  padding: 0;
}

/* ========== HEADER SECTION (LOGO + TITLE + BOSS IMAGE) ========== */
header {
  width: 100%;
  background: linear-gradient(90deg, #003d52, #026b8a);
  box-shadow: 0 2px 8px rgba(0,0,0,0.4);
}
.header-container {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 10px 50px;
}
.logo-left, .logo-right {
  height: 85px;
  width: 85px;
  border-radius: 50%;
  background-color: white;
  object-fit: cover;
  box-shadow: 0 0 10px rgba(0,0,0,0.3);
  border: 3px solid #fff;
}
.boss-container {
  position: relative;
  display: inline-block;
}

/* Tooltip styling */
.boss-tooltip {
  visibility: hidden;
  background-color: rgba(0, 0, 0, 0.8);
  color: #fff;
  text-align: center;
  padding: 6px 10px;
  border-radius: 6px;
  position: absolute;
  bottom: -35px;
  left: 50%;
  transform: translateX(-50%);
  white-space: nowrap;
  font-size: 0.9rem;
  font-weight: 500;
  opacity: 0;
  transition: opacity 0.3s ease;
  z-index: 10;
}

/* Show on hover */
.boss-container:hover .boss-tooltip {
  visibility: visible;
  opacity: 1;
}

.header-title {
  flex: 1;
  text-align: center;
  color: white;
}
.header-title h1 {
  font-size: 1.8rem;
  line-height: 1.5;
  margin: 0;
  font-weight: bold;
}
.header-title span {
  font-size: 1.2rem;
  color: #ffde59;
  font-weight: 600;
}

/* ========== NAVIGATION BAR ========== */
nav {
  display: flex;
  justify-content: center;
  flex-wrap: wrap;
  gap: 15px;
  background: rgba(255,255,255,0.1);
  padding: 10px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.3);
}
nav a {
  color: white;
  text-decoration: none;
  font-weight: bold;
  background: #026b8a;
  padding: 8px 15px;
  border-radius: 6px;
  transition: 0.3s;
}
nav a:hover, nav a.active {
  background: #ffb347;
  color: #003d52;
}

/* ========== DASHBOARD CARDS (TOP SUMMARY BOXES) ========== */
.cards {
  display: flex;
  justify-content: center;
  flex-wrap: wrap;
  gap: 20px;
  margin: 25px;
}
.card {
  background: rgba(255, 255, 255, 0.15);
  border-radius: 14px;
  padding: 20px;
  min-width: 200px;
  width: 220px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.3);
  transition: transform 0.3s;
}
.card:hover {
  transform: scale(1.05); /* Slight zoom when hovered */
}
.card h2 {
  margin: 0;
  font-size: 2rem;
  color: #ffde59;
}
.card p {
  margin: 5px 0 0;
  font-size: 1rem;
}

/* ========== CHART CONTAINER (BAR CHART BOX) ========== */
#chartContainer {
  width: 90%;
  max-width: 1000px;
  margin: 25px auto;
  height: 400px;
  background: rgba(255,255,255,0.05);
  border-radius: 12px;
  padding: 15px;
  box-shadow: 0 0 10px rgba(255,255,255,0.2);
}
canvas { width: 100% !important; height: 100% !important; }

/* ========== FOOTER ========== */
footer {
  text-align: center;
  color: #bbb;
  padding: 15px;
  font-size: 0.9rem;
}
#######FOR YEARS AND MONTH###############
/* ==========================================
   FOR YEARS AND MONTH ‚Äî FILTER STYLING
   ========================================== */
<!-- .filters { -->
  <!-- margin: 18px 0 5px; -->
<!-- } -->

/* Slightly move the filter box downward */
.filters {
  margin-top: 38px;     /* increased top margin for downward shift */
  margin-bottom: 10px;  /* keeps space before the cards */
}


/* Beautify Year & Month dropdowns */
.filters select {
  appearance: none;
  -webkit-appearance: none;
  -moz-appearance: none;
  background-color: #015871;
  color: #ffd666;
  font-weight: bold;
  padding: 10px 36px 10px 16px;
  border: 2px solid #00a8b5;
  border-radius: 10px;
  font-size: 1rem;
  cursor: pointer;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
  transition: all 0.25s ease;
}

/* Custom arrow (just a little decorative icon) */
.filters select::after {
  content: "‚ñº";
  position: absolute;
  right: 10px;
  top: 50%;
  transform: translateY(-50%);
  pointer-events: none;
}

/* Hover and focus states */
.filters select:hover {
  background-color: #02798f;
  border-color: #ffd666;
}
.filters select:focus {
  outline: none;
  box-shadow: 0 0 8px #ffd666;
}

/* Container background behind both dropdowns */
.filter-box {
  display: inline-flex;
  gap: 10px;
  background: rgba(255, 255, 255, 0.08);
  padding: 10px 20px;
  border-radius: 12px;
  backdrop-filter: blur(2px);
}

#########################################
</style>
</head>

<body>
<!-- ========== HEADER ========== -->
<header>
  <div class="header-container">
    <!-- Left Logo -->
    <!-- <img src="LOGO.png" alt="Company Logo" class="logo-left" /> -->
	<div class="boss-container">
	  <!-- <img src="LOGO.png" alt="Company Logo" class="logo-left" /> -->
	  <!-- <img src="LOGO.png" alt="Company Logo" class="logo-left" crossorigin="anonymous" /> -->
		  <img 
	  src="https://raw.githubusercontent.com/nijannfbd7890/WRM/main/LOGO.png" 
	  alt="Company Logo" 
	  class="logo-left" 
	  crossorigin="anonymous"
	/>
	  <span class="boss-tooltip">NFBD</span>
	</div>

    <!-- Center Title -->
    <div class="header-title">
      <h1>
        Namma Family Builder and Developer Pvt. Ltd<br>
        WRM Report Analysis Dashboard<br>
        <span>Team - Marketing Management</span>
      </h1>
    </div>

    <!-- Right Boss Image -->
    <div class="boss-container">
	  <!-- <img src="cs.jpg" alt="Boss Photo" class="logo-right" /> -->
	  <!-- <img src="cs.jpg" alt="Boss Photo" class="logo-right" crossorigin="anonymous" /> -->
	  <img 
	  src="https://raw.githubusercontent.com/nijannfbd7890/WRM/main/cs.jpg" 
	  alt="Boss Photo" 
	  class="logo-right" 
	  crossorigin="anonymous"
	/>
	  <span class="boss-tooltip">Mr.Ponnusamy Karthik Sir</span>
	</div>

  </div>
</header>

<!-- ========== NAVIGATION BAR ========== -->
<nav>
  <a href="index.html" class="active">üè† Dashboard</a>
  <a href="advance-range.html">üìä Advance Range</a>
  <a href="budget-range.html">üí∞ Budget Range</a>
  <a href="sqft-range.html">üìê Sqft Range</a>
  <a href="negotiable-range.html">ü§ù Negotiable Range</a>
  <a href="location-report.html">üìç Location</a>
</nav>
<!-- ========== FILTER DROPDOWNS ========== -->
<div class="filters">
  <select id="yearFilter"><option value="All">All Years</option></select>
  <select id="monthFilter"><option value="All">All Months</option></select>  
</div>


<!-- ========== SUMMARY CARDS (Top Stats) ========== -->
<div class="cards">
  <div class="card"><h2 id="totalBookings">0</h2><p>Overall Bookings</p></div>
  <div class="card"><h2 id="totalSqft">0</h2><p>Overall Sq Ft</p></div>
  <div class="card"><h2 id="selectedYear">All</h2><p>Selected Year</p></div>
  <div class="card"><h2 id="selectedMonth">All</h2><p>Selected Month</p></div>
</div>

<!-- ========== OVERVIEW CHART ========== -->
<div id="chartContainer">
  <canvas id="overviewChart"></canvas>
</div>
<div style="text-align:right; margin:10px 25px;">
  <button id="downloadBtn" style="
    background:#ffb347; 
    color:#003d52; 
    font-weight:600; 
    border:none; 
    border-radius:8px; 
    padding:8px 16px; 
    cursor:pointer;
    box-shadow:0 2px 6px rgba(0,0,0,0.3);
  ">
    ‚¨áÔ∏è Download PDF
  </button>
</div>

<!-- ========== FOOTER ========== -->
<footer>
  ¬© 2025 Namma Family Builder & Developer Pvt. Ltd ‚Äî All Rights Reserved
</footer>
<script>
/* ==========================================================
   JAVASCRIPT SECTION ‚Äî DASHBOARD FUNCTIONALITY
   ========================================================== */

let allData = [], monthsByYear = {}, chartInstance = null;

/* TEAM NAME NORMALIZATION
   - This ensures team names are consistent even if written differently in CSV
   - Example: "SURIYA SIR", "suriya sir", "Suriya sir" ‚Üí all treated as one */
const TEAM_CANONICAL = {
  "suriya sir & selvakumar sir": "Suriya Sir & Selvakumar Sir",
  "suriya sir": "Suriya Sir & Selvakumar Sir",
  "selvakumar sir": "Suriya Sir & Selvakumar Sir",
  "latha mam & ayyappan sir": "Latha Mam & Ayyappan Sir",
  "latha mam": "Latha Mam & Ayyappan Sir",
  "ayyappan sir": "Latha Mam & Ayyappan Sir"
};

/* Convert text to Title Case */
function titleCase(str) {
  if (!str) return "";
  return str.toLowerCase().replace(/\s*&\s*/g, " & ")
  .split(" ").filter(Boolean)
  .map(w => w[0].toUpperCase() + w.slice(1)).join(" ").trim();
}

/* Clean and normalize names */
function normalizeTeamName(v) {
  let key = (v || "").toLowerCase().replace(/\s*&\s*/g, " & ").replace(/\s+/g, " ").trim();
  return TEAM_CANONICAL[key] || titleCase(key);
}

/* ==========================================================
   STEP 1: LOAD CSV FILE FROM GITHUB USING PAPAPARSE
   ========================================================== */
Papa.parse("https://nijannfbd7890.github.io/WRM/workbook.csv", {
  download: true, header: true,
  complete: res => initDashboard(res.data)
});

/* ==========================================================
   STEP 2: INITIALIZE DASHBOARD AFTER CSV IS LOADED
   ========================================================== */
function initDashboard(data) {
  const norm = s => s ? s.trim().toLowerCase() : "";
  const f = data[0];

  // Identify important columns
  const teamKey = Object.keys(f).find(k => norm(k) === "team name");
  const sqftKeys = Object.keys(f).filter(k => norm(k).startsWith("actual total sq-ft"));
  const dateKey = Object.keys(f).find(k => norm(k).includes("booking"));

  // If any key is missing, show error
  if (!teamKey || !sqftKeys.length || !dateKey) {
    alert("‚ö† Missing required columns in CSV");
    return;
  }

  allData = data.filter(d => d[teamKey]); // Remove empty rows

  // Load filters and initial view
  populateFilters(allData, dateKey);
  updateDashboard("All", "All", teamKey, sqftKeys, dateKey);

  // Dropdown change events
  yearFilter.addEventListener("change", e => {
    updateMonthDropdown(e.target.value);
    updateDashboard(e.target.value, monthFilter.value, teamKey, sqftKeys, dateKey);
  });
  monthFilter.addEventListener("change", e => {
    updateDashboard(yearFilter.value, e.target.value, teamKey, sqftKeys, dateKey);
  });
}

/* ==========================================================
   STEP 3: CREATE FILTER DROPDOWN VALUES (YEAR / MONTH)
   ========================================================== */
function populateFilters(data, dateKey) {
  const years = [];
  monthsByYear = {};
  data.forEach(r => {
    const raw = (r[dateKey] || "").trim();
    if (!raw) return;
    const [d, m, y] = raw.split(/[-\/]/);
    if (!y) return;
    const year = parseInt(y);
    const mon = new Date(`${y}-${m}-01`).toLocaleString('en', { month: 'short' }) + "-" + y.slice(-2);
    if (!years.includes(year)) years.push(year);
    if (!monthsByYear[year]) monthsByYear[year] = [];
    if (!monthsByYear[year].includes(mon)) monthsByYear[year].push(mon);
  });

  // Sort years (latest first)
  years.sort((a,b)=>b-a);
  const yearSel = document.getElementById("yearFilter");
  yearSel.innerHTML = '<option value="All">All Years</option>';
  years.forEach(y => yearSel.innerHTML += `<option>${y}</option>`);
  updateMonthDropdown("All");
}

/* Populate months dynamically based on selected year */
function updateMonthDropdown(selectedYear) {
  const monthSel = document.getElementById("monthFilter");
  monthSel.innerHTML = '<option value="All">All Months</option>';
  if (selectedYear !== "All") {
    (monthsByYear[selectedYear] || []).forEach(m => monthSel.innerHTML += `<option>${m}</option>`);
  } else {
    const allMonths = [...new Set(Object.values(monthsByYear).flat())];
    allMonths.forEach(m => monthSel.innerHTML += `<option>${m}</option>`);
  }
}

/* ==========================================================
   STEP 4: UPDATE DASHBOARD ‚Äî CALCULATE TEAM TOTALS
   ========================================================== */
function updateDashboard(year, month, teamKey, sqftKeys, dateKey) {
  let filtered = allData.filter(r => r[dateKey]);

  // Filter by selected year/month
  if (year !== "All" || month !== "All") {
    filtered = filtered.filter(r => {
      const raw = (r[dateKey] || "").trim();
      const [d, m, y] = raw.split(/[-\/]/);
      if (!y) return false;
      const rowYear = parseInt(y);
      const rowMonth = new Date(`${y}-${m}-01`).toLocaleString('en', { month: 'short' }) + "-" + y.slice(-2);
      if (year !== "All" && rowYear != year) return false;
      if (month !== "All" && rowMonth.toLowerCase() != month.toLowerCase()) return false;
      return true;
    });
  }

  // Group bookings by Team
  const teams = {};
  filtered.forEach(r => {
    const team = normalizeTeamName(r[teamKey]);
    let sqft = 0;

    // Add all SQFT values from multiple columns
    sqftKeys.forEach(k => {
      const v = parseFloat((r[k] || "0").replace(/,/g, "")) || 0;
      sqft += v;
    });

    if (!teams[team]) teams[team] = { count: 0, sqft: 0 };
    teams[team].count++;
    teams[team].sqft += sqft;
  });

  // Sort teams by number of bookings (descending)
  const sorted = Object.entries(teams).sort((a,b)=>b[1].count-a[1].count);

  // Calculate totals
  const totalCount = sorted.reduce((a,[,v])=>a+v.count,0);
  const totalSqft = sorted.reduce((a,[,v])=>a+v.sqft,0);

  // Update cards
  document.getElementById("totalBookings").textContent = totalCount;
  document.getElementById("totalSqft").textContent = Math.round(totalSqft);
  document.getElementById("selectedYear").textContent = year;
  document.getElementById("selectedMonth").textContent = month;

  // Render the bar chart
  renderChart(sorted);
}

/* ==========================================================
   STEP 5: RENDER CHART USING CHART.JS
   ========================================================== */
function renderChart(dataArr) {
  const ctx = document.getElementById("overviewChart").getContext("2d");
  if (chartInstance) chartInstance.destroy(); // Reset old chart
  if (!dataArr.length) return;

  const labels = dataArr.map(([t]) => t); // Team names
  const counts = dataArr.map(([_,v]) => v.count); // Booking counts

  // Create colorful gradient chart
  chartInstance = new Chart(ctx,{
    type:"bar",
    plugins:[ChartDataLabels],
    data:{
      labels,
      datasets:[{
        label:"Total Bookings",
        data:counts,
        backgroundColor:(ctx)=>{
          const c=ctx.chart.ctx,area=ctx.chart.chartArea;
          if(!area)return"#00cc99";
          const g=c.createLinearGradient(0,area.bottom,0,area.top);
          g.addColorStop(0,"#ff9933");
          g.addColorStop(1,"#009933");
          return g;
        },
        borderColor:"rgba(255,255,255,0.8)",borderWidth:1
      }]
    },
    options:{
      responsive:true,maintainAspectRatio:false,
      plugins:{
        legend:{display:false},
        datalabels:{color:"white",anchor:"end",align:"start",font:{weight:"bold"},formatter:v=>v},
        title:{display:true,text:"Total Bookings per Team (Overview)",color:"white"}
      },
      scales:{
        x:{ticks:{color:"white",autoSkip:false,maxRotation:45,minRotation:45}},
        y:{ticks:{color:"white"},beginAtZero:true}
      }
    }
  });
}
</script>
<!-- === PDF DOWNLOAD (Same logic as index.html) === -->
<script>
document.getElementById("downloadBtn").addEventListener("click", async () => {
  const { jsPDF } = window.jspdf;
  const btn = document.getElementById("downloadBtn");
  const tooltips = document.querySelectorAll(".boss-tooltip");

  // Hide unnecessary UI before capture
  btn.style.visibility = "hidden";
  tooltips.forEach(t => (t.style.display = "none"));
  window.scrollTo(0, 0);

  // Capture the entire dashboard (just like index.html)
  const captureTarget = document.body;

  await html2canvas(captureTarget, {
    scale: 2.5,                 // High quality
    useCORS: true,              // Allow cross-origin images
    scrollX: 0,
    scrollY: 0,
    windowWidth: document.documentElement.scrollWidth,
    windowHeight: document.documentElement.scrollHeight,
    backgroundColor: "#01414d"  // Match dashboard background
  })
    .then(canvas => {
      const imgData = canvas.toDataURL("image/jpeg", 1.0);

      // Dynamically size PDF to match dashboard
      const pdfWidth = canvas.width * 0.264583; // px ‚Üí mm
      const pdfHeight = canvas.height * 0.264583;

      const pdf = new jsPDF({
        orientation: pdfWidth > pdfHeight ? "l" : "p",
        unit: "mm",
        format: [pdfWidth, pdfHeight]
      });

      pdf.addImage(imgData, "JPEG", 0, 0, pdfWidth, pdfHeight);

      // Auto file name
      const now = new Date();
      const fileName = `WRM_Dashboard_${String(now.getDate()).padStart(2,"0")}_${String(now.getMonth()+1).padStart(2,"0")}_${now.getFullYear()}.pdf`;
      pdf.save(fileName);
    })
    .catch(err => {
      console.error("PDF Generation Error:", err);
      alert("‚ö†Ô∏è PDF generation failed. Try again.");
    })
    .finally(() => {
      btn.style.visibility = "visible";
      tooltips.forEach(t => (t.style.display = ""));
    });
});
</script>

</body>
</html>
