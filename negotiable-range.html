<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Negotiable Range Report | WRM Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

<style>
 body {
    background: linear-gradient(135deg, #015871, #01414d);
    font-family: "Segoe UI", sans-serif;
    color: white;
    text-align: center;
    margin: 0;
  }

   /* HEADER */
header {
  width: 100%;
  background: linear-gradient(90deg, #003d52, #026b8a);
  box-shadow: 0 2px 8px rgba(0,0,0,0.4);
}
 .header-container {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 10px 50px;
}
.logo-left, .logo-right {
  height: 85px;
  width: 85px;
  border-radius: 50%;
  background-color: white;
  object-fit: cover;
  box-shadow: 0 0 10px rgba(0,0,0,0.3);
  border: 3px solid #fff;
}
  .header-title {
    flex: 1;
    text-align: center;
    color: white;
  }
  .header-title h1 {
    margin: 0;
    font-size: 1.6rem;
    line-height: 1.4;
  }
  .header-title span {
    font-size: 1.2rem;
    color: #ffd666;
  }

  /* NAV BAR */
  nav {
    display: flex;
    justify-content: center;
    gap: 15px;
    background: rgba(0,0,0,0.18);
    padding: 10px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.3);
  }
  nav a {
    color: white;
    text-decoration: none;
    font-weight: 600;
    background: #026b8a;
    padding: 8px 18px;
    border-radius: 999px;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    font-size: 0.98rem;
    transition: 0.25s;
  }
  nav a:hover {
    background: #ffb347;
    color: #003d52;
  }
  nav a.active {
    background: #ffb347;
    color: #003d52;
    box-shadow: 0 0 10px rgba(0,0,0,0.4);
  }

  <!-- /* FILTERS + CARDS */ -->
  <!-- .filters { -->
    <!-- margin: 18px 0 5px; -->
  <!-- } -->
  <!-- select { -->
    <!-- padding: 8px 14px; -->
    <!-- margin: 0 6px; -->
    <!-- border-radius: 8px; -->
    <!-- border: none; -->
    <!-- font-size: 1rem; -->
  <!-- } -->

  <!-- .cards { -->
    <!-- display: flex; -->
    <!-- justify-content: center; -->
    <!-- flex-wrap: wrap; -->
    <!-- gap: 18px; -->
    <!-- margin: 12px 15px 25px; -->
  <!-- } -->
  <!-- .card { -->
    <!-- background: rgba(255,255,255,0.12); -->
    <!-- border-radius: 18px; -->
    <!-- padding: 20px 30px; -->
    <!-- min-width: 220px; -->
    <!-- box-shadow: 0 4px 14px rgba(0,0,0,0.35); -->
  <!-- } -->
  <!-- .card h2 { -->
    <!-- margin: 0; -->
    <!-- font-size: 2.3rem; -->
    <!-- color: #ffd666; -->
  <!-- } -->
  <!-- .card p { -->
    <!-- margin: 6px 0 0; -->
    <!-- font-size: 1rem; -->
    <!-- opacity: 0.9; -->
  <!-- } -->
  
  .summary-cards {
  display: flex;
  justify-content: center;
  align-items: center;
  flex-wrap: wrap;
  gap: 20px;
  margin-top: 20px;
}

.card {
  background-color: #256475;
  color: #ffd65a;
  width: 300px;
  height: 150px;
  border-radius: 20px;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
  transition: transform 0.3s ease;
}

.card:hover {
  transform: translateY(-5px);
}

.card h2 {
  font-size: 2.5rem;
  font-weight: bold;
  margin: 0;
  color: #ffd65a;
}

.card p {
  color: #fff;
  font-size: 1.2rem;
  margin-top: 10px;
}


  /* TABLE */
  table {
    width: 95%;
    margin: 0 auto 18px;
    border-collapse: collapse;
    font-size: 0.9rem;
    text-align: center;
  }
  th, td {
    padding: 8px;
    border: 1px solid rgba(255,255,255,0.18);
  }
  th {
    background-color: rgba(255,255,255,0.18);
  }
  tfoot tr {
    background-color: rgba(255,255,255,0.3);
    font-weight: bold;
  }

  h2.section-title {
    margin-top: 0;
    margin-bottom: 12px;
  }

  /* CHART */
  #chartContainer {
    width: 92%;
    max-width: 1300px;
    margin: 12px auto 30px;
    height: 420px;
    background: rgba(0,0,0,0.18);
    border-radius: 22px;
    padding: 18px;
    box-shadow: 0 0 12px rgba(0,0,0,0.45);
  }
  canvas { width: 100% !important; height: 100% !important; }
</style>
</head>

<body>
<header>
  <div class="header-container">
    <img src="LOGO.png" alt="Company Logo" class="logo-left" />
    <div class="header-title">
      <h1>
        Namma Family Builder and Developer Pvt. Ltd<br>
        WRM Report Analysis Dashboard<br>
        <span>Team - Marketing Management</span>
      </h1>
    </div>
    <img src="cs.jpg" alt="Boss Photo" class="logo-right" />
  </div>
</header>

<nav>
  <a href="index.html">üè† Dashboard</a>
  <a href="advance-range.html">üìä Advance Range</a>
  <a href="budget-range.html">üí∞ Budget Range</a>
  <a href="sqft-range.html">üìê Sqft Range</a>
  <a href="negotiable-range.html" class="active">ü§ù Negotiable Range</a>
  <a href="location-report.html">üìç Location</a>
</nav>
<div class="filters">
  <select id="yearFilter"><option value="All">All Years</option></select>
  <select id="monthFilter"><option value="All">All Months</option></select>
</div>
<!-- ===== Summary Cards Section ===== -->
<div class="summary-cards">
  <div class="card">
    <h2 id="totalBookings">0</h2>
    <p>Total Bookings</p>
  </div>
  <div class="card">
    <h2 id="totalSqft">0</h2>
    <p>Total Sq Ft</p>
  </div>
  <div class="card">
    <h2 id="selectedYear">All</h2>
    <p>Selected Year</p>
  </div>
  <div class="card">
    <h2 id="selectedMonth">All</h2>
    <p>Selected Month</p>
  </div>
</div>
<!-- ===== End Summary Cards Section ===== -->

<h2>TEAM WISE PRICE NEGOTIABLE RANGE REPORT</h2>

<table id="dataTable">
  <thead>
    <tr>
      <th rowspan="2">Team Name</th>
      <th colspan="2">Overall</th>
      <th colspan="3">0 - 100</th>
      <th colspan="3">100 - 150</th>
      <th colspan="3">150 - 200</th>
      <th colspan="3">200 - 250</th>
      <th colspan="3">250 - 300</th>
      <th colspan="3">Above 300</th>
    </tr>
    <tr>
      <th>Count</th><th>Sq Ft</th>
      <th>Count</th><th>Sq Ft</th><th>%</th>
      <th>Count</th><th>Sq Ft</th><th>%</th>
      <th>Count</th><th>Sq Ft</th><th>%</th>
      <th>Count</th><th>Sq Ft</th><th>%</th>
      <th>Count</th><th>Sq Ft</th><th>%</th>
      <th>Count</th><th>Sq Ft</th><th>%</th>
    </tr>
  </thead>
  <tbody></tbody>
  <tfoot></tfoot>
</table>

<div id="chartContainer">
  <canvas id="bookingsChart"></canvas>
</div>
<div style="text-align:right; margin:10px 25px;">
  <button id="downloadBtn" style="
    background:#ffb347; 
    color:#003d52; 
    font-weight:600; 
    border:none; 
    border-radius:8px; 
    padding:8px 16px; 
    cursor:pointer;
    box-shadow:0 2px 6px rgba(0,0,0,0.3);
  ">
    ‚¨áÔ∏è Download PDF
  </button>
</div>
<!-- ========== FOOTER ========== -->
<footer>
  ¬© 2025 Namma Family Builder & Developer Pvt. Ltd ‚Äî All Rights Reserved
</footer>
<script>
let allData = [], monthsByYear = {}, chartInstance = null;

// ‚úÖ Shared Name Normalizer (same as other pages)
const TEAM_CANONICAL = {
  "suriya sir & selvakumar sir": "Suriya Sir & Selvakumar Sir",
  "suriya sir": "Suriya Sir & Selvakumar Sir",
  "selvakumar sir": "Suriya Sir & Selvakumar Sir",
  "latha mam & ayyappan sir": "Latha Mam & Ayyappan Sir",
  "latha mam": "Latha Mam & Ayyappan Sir",
  "ayyappan sir": "Latha Mam & Ayyappan Sir"
};
function titleCase(str){
  return str ? str.toLowerCase().replace(/\s*&\s*/g," & ")
  .split(" ").filter(Boolean)
  .map(w=>w[0].toUpperCase()+w.slice(1)).join(" ").trim() : "";
}
function normalizeTeamName(val){
  let k=(val||"").trim().toLowerCase().replace(/\s*&\s*/g," & ").replace(/\s+/g," ");
  return TEAM_CANONICAL[k] || titleCase(k);
}

// ‚úÖ Load CSV
Papa.parse("https://nijannfbd7890.github.io/WRM/workbook.csv", {
  download: true, header: true,
  complete: res => initDashboard(res.data)
});

function initDashboard(data){
  const norm=s=>s?s.trim().toLowerCase():"";
  const f=data[0];
  const teamKey=Object.keys(f).find(k=>norm(k)==="team name");
  const negoKey=Object.keys(f).find(k=>norm(k).includes("negotiable range"));
  const sqftKeys=Object.keys(f).filter(k=>norm(k).startsWith("actual total sq-ft"));
  const dateKey=Object.keys(f).find(k=>norm(k).includes("booking"));
  if(!teamKey||!negoKey||!sqftKeys.length||!dateKey){
    alert("‚ö† Missing required columns in CSV");
    return;
  }
  allData=data.filter(d=>d[teamKey]);
  populateFilters(allData,dateKey);
  updateDashboard("All","All",teamKey,negoKey,sqftKeys,dateKey);
  yearFilter.addEventListener("change",e=>{
    updateMonthDropdown(e.target.value);
    updateDashboard(e.target.value,monthFilter.value,teamKey,negoKey,sqftKeys,dateKey);
  });
  monthFilter.addEventListener("change",e=>{
    updateDashboard(yearFilter.value,e.target.value,teamKey,negoKey,sqftKeys,dateKey);
  });
}
function populateFilters(data, dateKey) {
  const years = [];
  monthsByYear = {};

  data.forEach(r => {
    const raw = (r[dateKey] || "").trim();
    if (!raw) return;
    const [d, m, y] = raw.split(/[-\/]/);
    if (!y) return;
    const year = parseInt(y);
    const mon = new Date(`${y}-${m}-01`).toLocaleString('en', { month: 'short' }) + "-" + y.slice(-2);
    if (!years.includes(year)) years.push(year);
    if (!monthsByYear[year]) monthsByYear[year] = [];
    if (!monthsByYear[year].includes(mon)) monthsByYear[year].push(mon);
  });

  years.sort((a, b) => b - a);
  const yearSel = document.getElementById("yearFilter");
  yearSel.innerHTML = '<option value="All">All Years</option>';
  years.forEach(y => yearSel.innerHTML += `<option>${y}</option>`);
  updateMonthDropdown("All");
}

function updateMonthDropdown(selectedYear) {
  const monthSel = document.getElementById("monthFilter");
  monthSel.innerHTML = '<option value="All">All Months</option>';
  if (selectedYear !== "All") {
    (monthsByYear[selectedYear] || []).forEach(m => monthSel.innerHTML += `<option>${m}</option>`);
  } else {
    const allMonths = [...new Set(Object.values(monthsByYear).flat())];
    allMonths.forEach(m => monthSel.innerHTML += `<option>${m}</option>`);
  }
}


function updateMonthDropdown(y){
  const ms=document.getElementById("monthFilter");
  ms.innerHTML='<option value="All">All Months</option>';
  if(y!=="All"){
    (monthsByYear[y]||[]).forEach(m=>ms.innerHTML+=`<option>${m}</option>`);
  } else {
    [...new Set(Object.values(monthsByYear).flat())].forEach(m=>ms.innerHTML+=`<option>${m}</option>`);
  }
}

function updateDashboard(year,month,teamKey,negoKey,sqftKeys,dateKey){
  let filtered=allData.filter(r=>r[dateKey]);
  if(year!=="All"||month!=="All"){
    filtered=filtered.filter(r=>{
      const raw=(r[dateKey]||"").trim(); const [d,m,y]=raw.split(/[-\/]/);
      if(!y)return false;
      const rowYear=parseInt(y);
      const rowMonth=new Date(`${y}-${m}-01`).toLocaleString('en',{month:'short'})+"-"+y.slice(-2);
      if(year!=="All"&&rowYear!=year)return false;
      if(month!=="All"&&rowMonth.toLowerCase()!=month.toLowerCase())return false;
      return true;
    });
  }

  const teams={};
  filtered.forEach(r=>{
    const team=normalizeTeamName(r[teamKey]);
    const nego=(r[negoKey]||"").toLowerCase();
    let sqft=0;
    sqftKeys.forEach(k=>{
      const v=parseFloat((r[k]||"0").replace(/,/g,""))||0;
      sqft+=v;
    });

    if(!teams[team]){
      teams[team]={totalCount:0,totalSqft:0,
        range0_100:{count:0,sqft:0},
        range100_150:{count:0,sqft:0},
        range150_200:{count:0,sqft:0},
        range200_250:{count:0,sqft:0},
        range250_300:{count:0,sqft:0},
        above300:{count:0,sqft:0}
      };
    }

    const t=teams[team];
    t.totalCount++; t.totalSqft+=sqft;

    if(nego.includes("0-100")) t.range0_100.count++, t.range0_100.sqft+=sqft;
    else if(nego.includes("100-150")) t.range100_150.count++, t.range100_150.sqft+=sqft;
    else if(nego.includes("150-200")) t.range150_200.count++, t.range150_200.sqft+=sqft;
    else if(nego.includes("200-250")) t.range200_250.count++, t.range200_250.sqft+=sqft;
    else if(nego.includes("250-300")) t.range250_300.count++, t.range250_300.sqft+=sqft;
    else if(nego.includes("above 300")) t.above300.count++, t.above300.sqft+=sqft;
  });

  const sorted=Object.entries(teams).sort((a,b)=>b[1].totalCount-a[1].totalCount);
  const tbody=document.querySelector("#dataTable tbody");
  const tfoot=document.querySelector("#dataTable tfoot");
  tbody.innerHTML=""; tfoot.innerHTML="";

  let g={totalCount:0,totalSqft:0,
    range0_100:{count:0,sqft:0},
    range100_150:{count:0,sqft:0},
    range150_200:{count:0,sqft:0},
    range200_250:{count:0,sqft:0},
    range250_300:{count:0,sqft:0},
    above300:{count:0,sqft:0}
  };
  const pct=(p,t)=>t?Math.round((p/t)*100)+"%":"0%";

  sorted.forEach(([team,t])=>{
    Object.keys(g).forEach(k=>{
      if(k!=="totalCount"&&k!=="totalSqft"){
        g[k].count+=t[k].count; g[k].sqft+=t[k].sqft;
      }
    });
    g.totalCount+=t.totalCount; g.totalSqft+=t.totalSqft;

    tbody.insertAdjacentHTML("beforeend",`
      <tr>
        <td>${team}</td>
        <td>${t.totalCount}</td><td>${Math.round(t.totalSqft)}</td>
        <td>${t.range0_100.count}</td><td>${Math.round(t.range0_100.sqft)}</td><td>${pct(t.range0_100.count,t.totalCount)}</td>
        <td>${t.range100_150.count}</td><td>${Math.round(t.range100_150.sqft)}</td><td>${pct(t.range100_150.count,t.totalCount)}</td>
        <td>${t.range150_200.count}</td><td>${Math.round(t.range150_200.sqft)}</td><td>${pct(t.range150_200.count,t.totalCount)}</td>
        <td>${t.range200_250.count}</td><td>${Math.round(t.range200_250.sqft)}</td><td>${pct(t.range200_250.count,t.totalCount)}</td>
        <td>${t.range250_300.count}</td><td>${Math.round(t.range250_300.sqft)}</td><td>${pct(t.range250_300.count,t.totalCount)}</td>
        <td>${t.above300.count}</td><td>${Math.round(t.above300.sqft)}</td><td>${pct(t.above300.count,t.totalCount)}</td>
      </tr>
    `);
  });

  tfoot.innerHTML=`
    <tr>
      <td>Grand Total</td>
      <td>${g.totalCount}</td><td>${Math.round(g.totalSqft)}</td>
      <td>${g.range0_100.count}</td><td>${Math.round(g.range0_100.sqft)}</td><td>${pct(g.range0_100.count,g.totalCount)}</td>
      <td>${g.range100_150.count}</td><td>${Math.round(g.range100_150.sqft)}</td><td>${pct(g.range100_150.count,g.totalCount)}</td>
      <td>${g.range150_200.count}</td><td>${Math.round(g.range150_200.sqft)}</td><td>${pct(g.range150_200.count,g.totalCount)}</td>
      <td>${g.range200_250.count}</td><td>${Math.round(g.range200_250.sqft)}</td><td>${pct(g.range200_250.count,g.totalCount)}</td>
      <td>${g.range250_300.count}</td><td>${Math.round(g.range250_300.sqft)}</td><td>${pct(g.range250_300.count,g.totalCount)}</td>
      <td>${g.above300.count}</td><td>${Math.round(g.above300.sqft)}</td><td>${pct(g.above300.count,g.totalCount)}</td>
    </tr>
  `;
	// ‚úÖ Update KPI cards
	document.getElementById("totalBookings").textContent = g.totalCount;
	document.getElementById("totalSqft").textContent = Math.round(g.totalSqft);
	document.getElementById("selectedYear").textContent = year;
	document.getElementById("selectedMonth").textContent = month;

  renderChart(sorted);
}

function renderChart(dataArr){
  const ctx=document.getElementById("bookingsChart").getContext("2d");
  if(chartInstance)chartInstance.destroy();
  if(!dataArr.length)return;
  const labels=dataArr.map(([t])=>t);
  const counts=dataArr.map(([_,v])=>v.totalCount);
  chartInstance=new Chart(ctx,{
    type:"bar",plugins:[ChartDataLabels],
    data:{labels,datasets:[{label:"Bookings",data:counts,
      backgroundColor:(ctx)=>{const c=ctx.chart.ctx,area=ctx.chart.chartArea;if(!area)return"#00cc99";
        const g=c.createLinearGradient(0,area.bottom,0,area.top);
        g.addColorStop(0,"#ff9933");g.addColorStop(1,"#009933");return g;},
      borderColor:"rgba(255,255,255,0.8)",borderWidth:1}]},
    options:{responsive:true,maintainAspectRatio:false,
      plugins:{legend:{display:false},
        datalabels:{color:"white",anchor:"end",align:"start",font:{weight:"bold"},formatter:v=>v},
        title:{display:true,text:"Total Bookings per Team (Negotiable Range)",color:"white"}},
      scales:{x:{ticks:{color:"white",autoSkip:false,maxRotation:45,minRotation:45}},
              y:{ticks:{color:"white"},beginAtZero:true}}}
  });
}
</script>
<script>
document.getElementById("downloadBtn").addEventListener("click", async () => {
  const { jsPDF } = window.jspdf;

  const btn = document.getElementById("downloadBtn");
  const tooltips = document.querySelectorAll(".boss-tooltip");

  // Hide button + tooltips during screenshot
  btn.style.visibility = "hidden";
  tooltips.forEach(t => t.style.display = "none");

  // Capture the whole visible dashboard
  const dashboard = document.body;

  await html2canvas(dashboard, {
    scale: 2,
    useCORS: true,
    backgroundColor: "#01414d"
  }).then(canvas => {
    const imgData = canvas.toDataURL("image/png");
    const pdf = new jsPDF("p", "mm", "a4");
    const pageWidth = pdf.internal.pageSize.getWidth();
    const pageHeight = pdf.internal.pageSize.getHeight();

    const imgWidth = pageWidth;
    const imgHeight = (canvas.height * pageWidth) / canvas.width;

    let y = 0;
    pdf.addImage(imgData, "PNG", 0, y, imgWidth, imgHeight);

    // Add extra pages if content is long
    if (imgHeight > pageHeight) {
      let heightLeft = imgHeight - pageHeight;
      while (heightLeft > 0) {
        y = heightLeft - imgHeight;
        pdf.addPage();
        pdf.addImage(imgData, "PNG", 0, y, imgWidth, imgHeight);
        heightLeft -= pageHeight;
      }
    }

    pdf.save("WRM_Dashboard.pdf");
  }).catch(err => {
    alert("‚ùå Error generating PDF: " + err);
  }).finally(() => {
    // Restore visibility
    btn.style.visibility = "visible";
    tooltips.forEach(t => t.style.display = "");
  });
});
</script>
</body>
</html>