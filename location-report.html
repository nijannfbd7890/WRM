<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Location Report | WRM Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<!-- For PDF download -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
 body {
    background: linear-gradient(135deg, #015871, #01414d);
    font-family: "Segoe UI", sans-serif;
    color: white;
    text-align: center;
    margin: 0;
  }

   /* HEADER */
header {
  width: 100%;
  background: linear-gradient(90deg, #003d52, #026b8a);
  box-shadow: 0 2px 8px rgba(0,0,0,0.4);
}
 .header-container {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 10px 50px;
}
.logo-left, .logo-right {
  height: 85px;
  width: 85px;
  border-radius: 50%;
  background-color: white;
  object-fit: cover;
  box-shadow: 0 0 10px rgba(0,0,0,0.3);
  border: 3px solid #fff;
}
  .header-title {
    flex: 1;
    text-align: center;
    color: white;
  }
  .header-title h1 {
    margin: 0;
    font-size: 1.6rem;
    line-height: 1.4;
  }
  .header-title span {
    font-size: 1.2rem;
    color: #ffd666;
  }
/* ==============================
   FILTERS (Year & Month) ‚Äî Styled Buttons Look
   ============================== */
.filters {
  margin-top: 38px;
  margin-bottom: 10px;
  display: flex;
  justify-content: center;
  gap: 15px;
}

.filters select {
  background-color: #015871;
  color: #ffd666;
  font-weight: bold;
  padding: 12px 24px;
  border: 2px solid #00a8b5;
  border-radius: 10px;
  font-size: 1rem;
  cursor: pointer;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
  transition: all 0.25s ease;
  text-align: center;
  appearance: none; /* hides default arrow */
}
  /* NAV BAR */
  nav {
    display: flex;
    justify-content: center;
    gap: 15px;
    background: rgba(0,0,0,0.18);
    padding: 10px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.3);
  }
  nav a {
    color: white;
    text-decoration: none;
    font-weight: 600;
    background: #026b8a;
    padding: 8px 18px;
    border-radius: 999px;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    font-size: 0.98rem;
    transition: 0.25s;
  }
  nav a:hover {
    background: #ffb347;
    color: #003d52;
  }
  nav a.active {
    background: #ffb347;
    color: #003d52;
    box-shadow: 0 0 10px rgba(0,0,0,0.4);
  }

/* ==============================
   FILTERS (Year & Month Dropdowns)
   ============================== */
.filters {
  margin-top: 38px;
  margin-bottom: 10px;
  display: flex;
  justify-content: center;
  gap: 15px;
}

.filters select {
  background-color: #015871;
  color: #ffd666;
  font-weight: bold;
  padding: 12px 24px;
  border: 2px solid #00a8b5;
  border-radius: 10px;
  font-size: 1rem;
  cursor: pointer;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
  transition: all 0.25s ease;
  text-align: center;
  appearance: none; /* hide default arrow */
}

/* Hover and focus styles */
.filters select:hover {
  background-color: #02798f;
  border-color: #ffd666;
  transform: scale(1.05);
}
.filters select:focus {
  outline: none;
  box-shadow: 0 0 8px #ffd666;
}
	
	
 .summary-cards {
  display: flex;
  justify-content: center;
  align-items: center;
  flex-wrap: wrap;
  gap: 20px;
  margin-top: 20px;
}

.card {
  background-color: #256475;
  color: #ffd65a;
  width: 300px;
  height: 150px;
  border-radius: 20px;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
  transition: transform 0.3s ease;
}

.card:hover {
  transform: translateY(-5px);
}

.card h2 {
  font-size: 2.5rem;
  font-weight: bold;
  margin: 0;
  color: #ffd65a;
}

.card p {
  color: #fff;
  font-size: 1.2rem;
  margin-top: 10px;
}

  /* TABLE */
  table {
    width: 95%;
    margin: 0 auto 18px;
    border-collapse: collapse;
    font-size: 0.9rem;
    text-align: center;
  }
  th, td {
    padding: 8px;
    border: 1px solid rgba(255,255,255,0.18);
  }
  th {
    background-color: rgba(255,255,255,0.18);
  }
  tfoot tr {
    background-color: rgba(255,255,255,0.3);
    font-weight: bold;
  }

  h2.section-title {
    margin-top: 0;
    margin-bottom: 12px;
  }

  /* CHART */
  #chartContainer {
    width: 92%;
    max-width: 1300px;
    margin: 12px auto 30px;
    height: 420px;
    background: rgba(0,0,0,0.18);
    border-radius: 22px;
    padding: 18px;
    box-shadow: 0 0 12px rgba(0,0,0,0.45);
  }
  canvas { width: 100% !important; height: 100% !important; }
</style>
</head>

<body>
<!-- HEADER SECTION -->
<header>
  <div class="header-container">
    <!-- <img src="LOGO.png" alt="Company Logo" class="logo-left" /> -->
	<img src="https://raw.githubusercontent.com/nijannfbd7890/WRM/main/LOGO.png" class="logo-left" crossorigin="anonymous" />
    <div class="header-title">
      <h1>
        Namma Family Builder and Developer Pvt. Ltd<br>
        WRM Report Analysis Dashboard<br>
        <span>Team - Marketing Management</span>
      </h1>
    </div>
    <!-- <img src="cs.jpg" alt="Boss Photo" class="logo-right" /> -->
	<img src="https://raw.githubusercontent.com/nijannfbd7890/WRM/main/cs.jpg" class="logo-right" crossorigin="anonymous" />
  </div>
</header>

<nav>
  <a href="index.html">üè† Dashboard</a>
  <a href="advance-range.html">üìä Advance Range</a>
  <a href="budget-range.html">üí∞ Budget Range</a>
  <a href="sqft-range.html">üìê Sqft Range</a>
  <a href="negotiable-range.html">ü§ù Negotiable Range</a>
  <a href="location-report.html" class="active">üìç Location</a>
</nav>
<div class="filters">
  <select id="yearFilter"><option value="All">All Years</option></select>
  <select id="monthFilter"><option value="All">All Months</option></select>
</div>
<!-- ===== Summary Cards Section ===== -->
<div class="summary-cards">
  <div class="card">
    <h2 id="totalBookings">0</h2>
    <p>Total Bookings</p>
  </div>
  <div class="card">
    <h2 id="totalSqft">0</h2>
    <p>Total Sq Ft</p>
  </div>
  <div class="card">
    <h2 id="selectedYear">All</h2>
    <p>Selected Year</p>
  </div>
  <div class="card">
    <h2 id="selectedMonth">All</h2>
    <p>Selected Month</p>
  </div>
</div>
<!-- ===== End Summary Cards Section ===== -->

<h2>LOCATION & TEAM WISE BOOKING REPORT</h2>

<table id="dataTable">
  <thead>
    <tr>
      <th rowspan="2">Team Name</th>
      <th colspan="2">Overall</th>
      <th colspan="3">GST</th>
      <th colspan="3">NELLIKUPPAM</th>
      <th colspan="3">OMR</th>
      <th colspan="3">ECR</th>
    </tr>
    <tr>
      <th>Count</th><th>Sq Ft</th>
      <th>Count</th><th>Sq Ft</th><th>%</th>
      <th>Count</th><th>Sq Ft</th><th>%</th>
      <th>Count</th><th>Sq Ft</th><th>%</th>
      <th>Count</th><th>Sq Ft</th><th>%</th>
    </tr>
  </thead>
  <tbody></tbody>
  <tfoot></tfoot>
</table>

<div id="chartContainer">
  <canvas id="bookingsChart"></canvas>
</div>
<div style="text-align:right; margin:10px 25px;">
  <button id="downloadBtn" style="
    background:#ffb347; 
    color:#003d52; 
    font-weight:600; 
    border:none; 
    border-radius:8px; 
    padding:8px 16px; 
    cursor:pointer;
    box-shadow:0 2px 6px rgba(0,0,0,0.3);
  ">
    ‚¨áÔ∏è Download PDF
  </button>
</div>
<!-- ========== FOOTER ========== -->
<footer>
  ¬© 2025 Namma Family Builder & Developer Pvt. Ltd ‚Äî All Rights Reserved
</footer>

<script>
let allData = [], chartInstance = null;

// ‚úÖ Name Normalization for consistency
const TEAM_CANONICAL = {
  "suriya sir & selvakumar sir": "Suriya Sir & Selvakumar Sir",
  "suriya sir": "Suriya Sir & Selvakumar Sir",
  "selvakumar sir": "Suriya Sir & Selvakumar Sir",
  "latha mam & ayyappan sir": "Latha Mam & Ayyappan Sir",
  "latha mam": "Latha Mam & Ayyappan Sir",
  "ayyappan sir": "Latha Mam & Ayyappan Sir"
};
// ‚úÖ Master team list (same as other reports)
const MASTER_TEAMS = [
  "Ranjith Sir",
  "Suriya Sir & Selvakumar Sir",
  "Latha Mam & Ayyappan Sir",
  "Prabhakaran Sir",
  "Ashok Sir",
  "Rajiv Sir",
  "Gopi Sir",
  "Thangadurai Sir",
  "Senthil Sir",
  "Kumaresan Sir",
  "Sankar Sir"
];

function titleCase(str){
  return str ? str.toLowerCase().replace(/\s*&\s*/g," & ")
  .split(" ").filter(Boolean)
  .map(w=>w[0].toUpperCase()+w.slice(1)).join(" ").trim() : "";
}
function normalizeTeamName(val){
  let k=(val||"").trim().toLowerCase().replace(/\s*&\s*/g," & ").replace(/\s+/g," ");
  return TEAM_CANONICAL[k] || titleCase(k);
}

// ‚úÖ Load CSV
Papa.parse("https://nijannfbd7890.github.io/WRM/workbook.csv", {
  download: true, header: true,
  complete: res => initDashboard(res.data)
});

// ‚úÖ INIT DASHBOARD (no booking date logic)
function initDashboard(data){
  const norm = s => s ? s.trim().toLowerCase() : "";
  const f = data[0];
  console.log("CSV Headers:", Object.keys(f));
  
  // Clean and flexible header matching (handles spaces and minor text differences)
	const teamKey = Object.keys(f).find(k => norm(k).replace(/\s+/g,'') === "teamname");
	const locKey = Object.keys(f).find(k => norm(k).replace(/\s+/g,'') === "location");
	const sqftKeys = Object.keys(f).filter(k => norm(k).replace(/\s+/g,'').includes("total"));
	console.log("Detected Columns:", { teamKey, locKey, sqftKeys });



  if(!teamKey || !locKey || !sqftKeys.length){
    alert("‚ö† Missing required columns (TEAM NAME / LOCATION / SQ-FT) in CSV");
    return;
  }

  allData = data.filter(d => d[teamKey]);
  updateDashboard(teamKey, locKey, sqftKeys);
  // üîπ Find the first column that looks like a date
// üîπ Find the first column that looks like a date
const dateKey = Object.keys(f).find(k => norm(k).includes("agreement date")) 
             || Object.keys(f).find(k => norm(k).includes("booking date"))
             || Object.keys(f).find(k => norm(k).includes("date"));
console.log("Detected date column:", dateKey);

// üîπ Populate Year & Month dropdowns dynamically
if (dateKey) {
  const yearMap = new Map(); // { year: Set(monthNames) }

  data.forEach(d => {
    const val = (d[dateKey] || "").trim();
    const match = val.match(/(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})/);
    if (match) {
      const day = parseInt(match[1]);
      const monthNum = parseInt(match[2]);
      const year = match[3].length === 2 ? `20${match[3]}` : match[3];
      const monthName = new Date(2000, monthNum - 1).toLocaleString("en", { month: "short" });
      const label = `${monthName}-${year.slice(-2)}`;
      if (!yearMap.has(year)) yearMap.set(year, new Set());
      yearMap.get(year).add(label);
    }
  });

  const yearSelect = document.getElementById("yearFilter");
  const monthSelect = document.getElementById("monthFilter");

  // üîπ Sort years (current first, then descending)
  const years = [...yearMap.keys()].sort((a,b) => b - a);
  const currentYear = new Date().getFullYear().toString();
  if (!years.includes(currentYear)) years.unshift(currentYear);

  yearSelect.innerHTML = `<option value="All">All Years</option>` +
    years.map(y => `<option value="${y}">${y}</option>`).join("");

  // üîπ Populate months based on selected year
  function updateMonthDropdown(selectedYear) {
    const monthOrder = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
    let months = new Set();

    if (selectedYear === "All") {
      // combine all years' months
      yearMap.forEach(set => set.forEach(m => months.add(m)));
    } else if (yearMap.has(selectedYear)) {
      months = yearMap.get(selectedYear);
    }

    const sortedMonths = [...months].sort((a,b) =>
      monthOrder.indexOf(a.slice(0,3)) - monthOrder.indexOf(b.slice(0,3))
    );

    monthSelect.innerHTML = `<option value="All">All Months</option>` +
      sortedMonths.map(m => `<option value="${m}">${m}</option>`).join("");
  }

  // Initial populate
  updateMonthDropdown("All");

  // üîπ Event listeners for filtering
  yearSelect.addEventListener("change", () => {
    const selectedYear = yearSelect.value;
    updateMonthDropdown(selectedYear);
    filterByDate(selectedYear, monthSelect.value, dateKey, teamKey, locKey, sqftKeys);
  });

  monthSelect.addEventListener("change", () => {
    filterByDate(yearSelect.value, monthSelect.value, dateKey, teamKey, locKey, sqftKeys);
  });
}



  // Hide filters since no year/month
  <!-- document.getElementById("yearFilter").style.display = "none"; -->
  <!-- document.getElementById("monthFilter").style.display = "none"; -->
}

// ‚úÖ UPDATE DASHBOARD
function updateDashboard(teamKey, locKey, sqftKeys){
  // ‚úÖ Initialize all teams first (same pattern as Advance Range)
const teams = {};
MASTER_TEAMS.forEach(t => {
  const team = normalizeTeamName(t);
  teams[team] = {
    totalCount:0, totalSqft:0,
    gst:{count:0,sqft:0},
    nellikuppam:{count:0,sqft:0},
    omr:{count:0,sqft:0},
    ecr:{count:0,sqft:0}
  };
});

allData.forEach(r=>{

    const team = normalizeTeamName(r[teamKey]);
    const locText = (r[locKey] || "").toLowerCase().trim();
    let sqft = 0;
    sqftKeys.forEach(k=>{
      const v = parseFloat((r[k]||"0").replace(/,/g,""))||0;
      sqft += v;
    });

    

    const t = teams[team];
    t.totalCount++;
    t.totalSqft += sqft;

    if(locText.includes("gst")) {
      t.gst.count++; t.gst.sqft += sqft;
    } else if(locText.includes("nellik") || locText.includes("nellikuppam")) {
      t.nellikuppam.count++; t.nellikuppam.sqft += sqft;
    } else if(locText.includes("omr")) {
      t.omr.count++; t.omr.sqft += sqft;
    } else if(locText.includes("ecr")) {
      t.ecr.count++; t.ecr.sqft += sqft;
    }
  });

  const sorted = Object.entries(teams).sort((a, b) => {
  if (b[1].totalSqft === 0 && a[1].totalSqft === 0)
    return a[0].localeCompare(b[0]);
  if (b[1].totalSqft === 0) return -1;
  if (a[1].totalSqft === 0) return 1;
  return b[1].totalSqft - a[1].totalSqft;
});

  const tbody = document.querySelector("#dataTable tbody");
  const tfoot = document.querySelector("#dataTable tfoot");
  tbody.innerHTML = ""; tfoot.innerHTML = "";

  let g = {totalCount:0,totalSqft:0,gst:{count:0,sqft:0},nellikuppam:{count:0,sqft:0},omr:{count:0,sqft:0},ecr:{count:0,sqft:0}};
  const pct = (rangeSqft, totalSqft) =>
  totalSqft ? Math.round((rangeSqft / totalSqft) * 100) + "%" : "0%";


  sorted.forEach(([team,t])=>{
    g.totalCount+=t.totalCount; g.totalSqft+=t.totalSqft;
    g.gst.count+=t.gst.count; g.gst.sqft+=t.gst.sqft;
    g.nellikuppam.count+=t.nellikuppam.count; g.nellikuppam.sqft+=t.nellikuppam.sqft;
    g.omr.count+=t.omr.count; g.omr.sqft+=t.omr.sqft;
    g.ecr.count+=t.ecr.count; g.ecr.sqft+=t.ecr.sqft;

    tbody.insertAdjacentHTML("beforeend",`
      <tr>
        <td>${team}</td>
        <td>${t.totalCount}</td><td>${Math.round(t.totalSqft)}</td>
        <td>${t.gst.count}</td><td>${Math.round(t.gst.sqft)}</td><td>${pct(t.gst.sqft,t.totalSqft)}</td>
        <td>${t.nellikuppam.count}</td><td>${Math.round(t.nellikuppam.sqft)}</td><td>${pct(t.nellikuppam.sqft,t.totalSqft)}</td>
        <td>${t.omr.count}</td><td>${Math.round(t.omr.sqft)}</td><td>${pct(t.omr.sqft,t.totalSqft)}</td>
        <td>${t.ecr.count}</td><td>${Math.round(t.ecr.sqft)}</td><td>${pct(t.ecr.sqft,t.totalSqft)}</td>
      </tr>
    `);
  });

  // ‚úÖ Grand Total Row
  tfoot.innerHTML = `
    <tr>
      <td>Grand Total</td>
      <td>${g.totalCount}</td><td>${Math.round(g.totalSqft)}</td>
      <td>${g.gst.count}</td><td>${Math.round(g.gst.sqft)}</td><td>${pct(g.gst.sqft,g.totalSqft)}</td>
      <td>${g.nellikuppam.count}</td><td>${Math.round(g.nellikuppam.sqft)}</td><td>${pct(g.nellikuppam.sqft,g.totalSqft)}</td>
      <td>${g.omr.count}</td><td>${Math.round(g.omr.sqft)}</td><td>${pct(g.omr.sqft,g.totalSqft)}</td>
      <td>${g.ecr.count}</td><td>${Math.round(g.ecr.sqft)}</td><td>${pct(g.ecr.sqft,g.totalSqft)}</td>
    </tr>
  `;

  // ‚úÖ Update Summary Cards
  document.getElementById("totalBookings").textContent = g.totalCount;
  document.getElementById("totalSqft").textContent = Math.round(g.totalSqft);
  document.getElementById("selectedYear").textContent = "All";
  document.getElementById("selectedMonth").textContent = "All";

  renderChart(sorted);
}
function filterByDate(year, month, dateKey, teamKey, locKey, sqftKeys) {
  let filtered = allData;

  if (year !== "All" || month !== "All") {
    filtered = allData.filter(d => {
      const dateStr = (d[dateKey] || "").trim();
      if (!dateStr) return false;
      const m = dateStr.match(/(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})/);
      if (!m) return false;
      const monthNum = parseInt(m[2]);
      const yr = m[3].length === 2 ? `20${m[3]}` : m[3];
      const monthName = new Date(2000, monthNum - 1).toLocaleString("en", { month: "short" });
      const monthLabel = `${monthName}-${yr.slice(-2)}`;

      if (year !== "All" && yr !== year) return false;
      if (month !== "All" && monthLabel.toLowerCase() !== month.toLowerCase()) return false;
      return true;
    });
  }

  // ‚úÖ Update dashboard with filtered data
  allData = filtered;
  updateDashboard(teamKey, locKey, sqftKeys);
}



// ‚úÖ CHART RENDERING
function renderChart(dataArr){
  const ctx=document.getElementById("bookingsChart").getContext("2d");
  if(chartInstance) chartInstance.destroy();
  if(!dataArr.length) return;

  const labels = dataArr.map(([t])=>t);
  const counts = dataArr.map(([_,v])=>v.totalCount);

  chartInstance = new Chart(ctx,{
    type:"bar",plugins:[ChartDataLabels],
    data:{labels,datasets:[{label:"Bookings",data:counts,
      backgroundColor:(ctx)=>{const c=ctx.chart.ctx,area=ctx.chart.chartArea;if(!area)return"#00cc99";
        const g=c.createLinearGradient(0,area.bottom,0,area.top);
        g.addColorStop(0,"#ff9933");g.addColorStop(1,"#009933");return g;},
      borderColor:"rgba(255,255,255,0.8)",borderWidth:1}]},
    options:{responsive:true,maintainAspectRatio:false,
      plugins:{legend:{display:false},
        datalabels:{color:"white",anchor:"end",align:"start",font:{weight:"bold"},formatter:v=>v},
        title:{display:true,text:"Total Bookings per Team (Location)",color:"white"}},
      scales:{x:{ticks:{color:"white",autoSkip:false,maxRotation:45,minRotation:45}},
              y:{ticks:{color:"white"},beginAtZero:true}}}
  });
}
</script>


<!-- === PDF DOWNLOAD (Same logic as index.html) === -->
<script>
document.getElementById("downloadBtn").addEventListener("click", async () => {
  const { jsPDF } = window.jspdf;
  const btn = document.getElementById("downloadBtn");
  const tooltips = document.querySelectorAll(".boss-tooltip");

  // Hide unnecessary UI before capture
  btn.style.visibility = "hidden";
  tooltips.forEach(t => (t.style.display = "none"));
  window.scrollTo(0, 0);

  // Capture the entire dashboard (just like index.html)
  const captureTarget = document.body;

  await html2canvas(captureTarget, {
    scale: 2.5,                 // High quality
    useCORS: true,              // Allow cross-origin images
    scrollX: 0,
    scrollY: 0,
    windowWidth: document.documentElement.scrollWidth,
    windowHeight: document.documentElement.scrollHeight,
    backgroundColor: "#01414d"  // Match dashboard background
  })
    .then(canvas => {
      const imgData = canvas.toDataURL("image/jpeg", 1.0);

      // Dynamically size PDF to match dashboard
      const pdfWidth = canvas.width * 0.264583; // px ‚Üí mm
      const pdfHeight = canvas.height * 0.264583;

      const pdf = new jsPDF({
        orientation: pdfWidth > pdfHeight ? "l" : "p",
        unit: "mm",
        format: [pdfWidth, pdfHeight]
      });

      pdf.addImage(imgData, "JPEG", 0, 0, pdfWidth, pdfHeight);

      // Auto file name
      const now = new Date();
      const fileName = `WRM_Location_Dashboard_${String(now.getDate()).padStart(2,"0")}_${String(now.getMonth()+1).padStart(2,"0")}_${now.getFullYear()}.pdf`;
      pdf.save(fileName);
    })
    .catch(err => {
      console.error("PDF Generation Error:", err);
      alert("‚ö†Ô∏è PDF generation failed. Try again.");
    })
    .finally(() => {
      btn.style.visibility = "visible";
      tooltips.forEach(t => (t.style.display = ""));
    });
});
</script>
</body>
</html>